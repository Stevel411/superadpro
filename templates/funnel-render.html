<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>{{ page.headline or page.title }}</title>
<meta name="description" content="{{ page.subheadline or '' }}">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Rethink+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans','Rethink Sans',sans-serif;min-height:100vh}

{% set sc = page.color_scheme or 'dark' %}
{% if sc == 'custom' and page.custom_bg %}body{background:{{ page.custom_bg }};color:#e2e8f0}
{% elif sc == 'light' %}body{background:#f5f7fb;color:#0f172a}
{% elif sc == 'gradient' %}body{background:linear-gradient(160deg,#0a0a1a,#1a1a4a,#0a0a2a);color:#e2e8f0}
{% elif sc == 'ocean' %}body{background:linear-gradient(160deg,#0a1628,#0a2840,#061420);color:#e2e8f0}
{% elif sc == 'fire' %}body{background:linear-gradient(160deg,#1a0a0a,#2a1a0a,#1a0a05);color:#e2e8f0}
{% else %}body{background:#0a0a1a;color:#e2e8f0}{% endif %}

.page-footer{text-align:center;padding:32px 24px 16px;font-size:11px;color:{% if sc == 'light' %}#b0bec5{% else %}rgba(255,255,255,0.12){% endif %};letter-spacing:0.5px}
.page-footer a{color:{% if sc == 'light' %}#90a4ae{% else %}rgba(255,255,255,0.2){% endif %};text-decoration:none}
.page-footer a:hover{color:{{ page.accent_color or '#38bdf8' }}}
@media(max-width:768px){[style*="grid-template-columns: 1fr 1fr"],[style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr !important}}
</style>
</head>
<body>

<div id="pageContent"></div>

{% if page.gjs_html %}
<!-- GrapesJS Visual Builder Output -->
<style>{{ page.gjs_css or '' }}</style>
<div id="gjsContent">{{ page.gjs_html|safe }}</div>
<script>document.getElementById('pageContent').style.display='none';</script>
<script>
// Auto-wire all forms on the page to the lead capture API
document.querySelectorAll('#gjsContent form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const data = {page_id: {{ page.id }}};
    for (const [k,v] of fd.entries()) {
      const key = k.toLowerCase();
      if (key.includes('email') || key === 'email') data.email = v;
      else if (key.includes('name') || key === 'name') data.name = v;
      else if (key.includes('phone') || key === 'phone') data.phone = v;
    }
    // Also try input types
    if (!data.email) {
      const emailInput = form.querySelector('input[type="email"]');
      if (emailInput) data.email = emailInput.value;
    }
    if (!data.name) {
      const nameInput = form.querySelector('input[type="text"]');
      if (nameInput) data.name = nameInput.value;
    }
    if (!data.email) { alert('Please enter your email'); return; }
    const btn = form.querySelector('button[type="submit"]');
    if (btn) { btn.disabled = true; btn.textContent = 'Submitting...'; }
    try {
      const res = await fetch('/api/leads/capture', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      const result = await res.json();
      if (result.success) {
        if (result.redirect) {
          window.location.href = result.redirect;
        } else {
          if (btn) btn.textContent = 'âœ“ Success!';
          form.reset();
        }
      }
    } catch(err) {
      if (btn) { btn.disabled = false; btn.textContent = 'Try Again'; }
    }
  });
});
</script>
{% endif %}

<div class="page-footer">Powered by <a href="{{ owner_ref_link }}">SuperAdPro</a></div>

<!-- AI SALES CHATBOT WIDGET -->
<div id="chatWidget">
  <!-- Floating bubble -->
  <div id="chatBubble" onclick="toggleChat()">
    <svg id="chatIconOpen" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    <svg id="chatIconClose" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    <span id="chatPulse"></span>
  </div>

  <!-- Chat window -->
  <div id="chatWindow">
    <div id="chatHeader">
      <div id="chatHeaderInfo">
        <div id="chatAvatar">AI</div>
        <div>
          <div id="chatHeaderName">{{ owner_name }}'s Assistant</div>
          <div id="chatHeaderStatus"><span id="chatDot"></span> Online now</div>
        </div>
      </div>
      <button onclick="toggleChat()" id="chatCloseBtn">&times;</button>
    </div>
    <div id="chatMessages">
      <div class="chat-msg bot">
        <div class="chat-msg-bubble">Hey there! ðŸ‘‹ I'm {{ owner_name }}'s AI assistant. I can answer any questions you have about this opportunity. What would you like to know?</div>
      </div>
    </div>
    <div id="chatInput">
      <input type="text" id="chatMsgInput" placeholder="Type your question..." autocomplete="off" onkeydown="if(event.key==='Enter')sendChat()">
      <button onclick="sendChat()" id="chatSendBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
</div>

<style>
/* Chat Widget Styles */
#chatWidget{position:fixed;bottom:24px;right:24px;z-index:9999;font-family:'DM Sans','Rethink Sans',sans-serif}

/* Floating Bubble */
#chatBubble{width:64px;height:64px;border-radius:50%;background:{{ page.accent_color or '#38bdf8' }};display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 24px rgba(0,0,0,0.3);transition:transform .2s,box-shadow .2s;position:relative}
#chatBubble:hover{transform:scale(1.08);box-shadow:0 6px 32px rgba(0,0,0,0.4)}
#chatPulse{position:absolute;width:100%;height:100%;border-radius:50%;border:3px solid {{ page.accent_color or '#38bdf8' }};animation:chatPulseAnim 2s infinite;pointer-events:none}
@keyframes chatPulseAnim{0%{transform:scale(1);opacity:.6}100%{transform:scale(1.5);opacity:0}}

/* Chat Window */
#chatWindow{display:none;position:absolute;bottom:80px;right:0;width:380px;max-height:520px;border-radius:20px;overflow:hidden;box-shadow:0 12px 48px rgba(0,0,0,0.35);flex-direction:column;animation:chatSlideUp .3s ease}
@keyframes chatSlideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* Header */
#chatHeader{background:{{ page.accent_color or '#38bdf8' }};padding:16px 20px;display:flex;align-items:center;justify-content:space-between}
#chatHeaderInfo{display:flex;align-items:center;gap:12px}
#chatAvatar{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;color:#fff}
#chatHeaderName{font-weight:700;color:#fff;font-size:16px}
#chatHeaderStatus{font-size:16px;color:rgba(255,255,255,0.8);display:flex;align-items:center;gap:6px}
#chatDot{width:8px;height:8px;border-radius:50%;background:#4ade80;display:inline-block;animation:dotPulse 1.5s infinite}
@keyframes dotPulse{0%,100%{opacity:1}50%{opacity:.4}}
#chatCloseBtn{background:none;border:none;color:#fff;font-size:28px;cursor:pointer;line-height:1;padding:0 4px}

/* Messages Area */
#chatMessages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;
{% if (page.color_scheme or 'dark') == 'light' %}background:#eef2f7{% else %}background:#0f172a{% endif %};
min-height:280px;max-height:340px}

.chat-msg{display:flex;gap:8px;max-width:88%}
.chat-msg.bot{align-self:flex-start}
.chat-msg.user{align-self:flex-end;flex-direction:row-reverse}
.chat-msg-bubble{padding:12px 16px;border-radius:16px;font-size:16px;line-height:1.5}
.chat-msg.bot .chat-msg-bubble{
{% if (page.color_scheme or 'dark') == 'light' %}background:#fff;color:#1e293b;box-shadow:0 1px 4px rgba(0,40,100,0.06){% else %}background:#1e293b;color:#e2e8f0{% endif %};
border-bottom-left-radius:4px}
.chat-msg.user .chat-msg-bubble{background:{{ page.accent_color or '#38bdf8' }};color:#fff;border-bottom-right-radius:4px}

/* Typing indicator */
.typing-indicator{display:flex;gap:4px;padding:12px 16px;border-radius:16px;border-bottom-left-radius:4px;align-self:flex-start;
{% if (page.color_scheme or 'dark') == 'light' %}background:#fff{% else %}background:#1e293b{% endif %}}
.typing-dot{width:8px;height:8px;border-radius:50%;background:{{ page.accent_color or '#38bdf8' }};animation:typingBounce .6s infinite alternate}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typingBounce{from{opacity:.3;transform:translateY(0)}to{opacity:1;transform:translateY(-4px)}}

/* Input Area */
#chatInput{display:flex;gap:8px;padding:12px 16px;
{% if (page.color_scheme or 'dark') == 'light' %}background:#fff;border-top:1px solid #e2e8f0{% else %}background:#1e293b;border-top:1px solid #2d3b4e{% endif %}}
#chatMsgInput{flex:1;border:none;outline:none;font-size:16px;font-family:inherit;padding:10px 14px;border-radius:24px;
{% if (page.color_scheme or 'dark') == 'light' %}background:#eef2f7;color:#0f172a{% else %}background:#0f172a;color:#e2e8f0{% endif %}}
#chatMsgInput::placeholder{color:#64748b}
#chatSendBtn{width:40px;height:40px;border:none;border-radius:50%;background:{{ page.accent_color or '#38bdf8' }};color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .15s}
#chatSendBtn:hover{transform:scale(1.1)}
#chatSendBtn:disabled{opacity:.5;transform:none;cursor:default}

/* Mobile responsive */
@media(max-width:480px){
  #chatWindow{width:calc(100vw - 32px);right:-8px;bottom:74px;max-height:70vh}
  #chatBubble{width:56px;height:56px}
  #chatBubble svg{width:24px;height:24px}
}
</style>

<script>
// Chat widget logic
const CHAT_PAGE_ID = {{ page.id }};
const CHAT_OWNER = '{{ owner_name }}';
let chatOpen = false;
let chatHistory = [];
let chatSending = false;

function toggleChat() {
  chatOpen = !chatOpen;
  const win = document.getElementById('chatWindow');
  const iconOpen = document.getElementById('chatIconOpen');
  const iconClose = document.getElementById('chatIconClose');
  const pulse = document.getElementById('chatPulse');
  
  if (chatOpen) {
    win.style.display = 'flex';
    iconOpen.style.display = 'none';
    iconClose.style.display = 'block';
    pulse.style.display = 'none';
    document.getElementById('chatMsgInput').focus();
  } else {
    win.style.display = 'none';
    iconOpen.style.display = 'block';
    iconClose.style.display = 'none';
    pulse.style.display = 'block';
  }
}

function addMessage(text, role) {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg ' + (role === 'user' ? 'user' : 'bot');
  div.innerHTML = '<div class="chat-msg-bubble">' + text.replace(/\n/g, '<br>') + '</div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function showTyping() {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.id = 'typingIndicator';
  div.className = 'typing-indicator';
  div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function hideTyping() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

async function sendChat() {
  if (chatSending) return;
  const input = document.getElementById('chatMsgInput');
  const msg = input.value.trim();
  if (!msg) return;
  
  input.value = '';
  addMessage(msg, 'user');
  chatHistory.push({ role: 'user', content: msg });
  
  chatSending = true;
  document.getElementById('chatSendBtn').disabled = true;
  showTyping();
  
  try {
    const res = await fetch('/api/chat/' + CHAT_PAGE_ID, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg, history: chatHistory })
    });
    const data = await res.json();
    hideTyping();
    
    const reply = data.reply || "Sorry, I couldn't process that. Please try again!";
    addMessage(reply, 'bot');
    chatHistory.push({ role: 'assistant', content: reply });
  } catch (e) {
    hideTyping();
    addMessage("Hmm, something went wrong. Please try again in a moment!", 'bot');
  }
  
  chatSending = false;
  document.getElementById('chatSendBtn').disabled = false;
  document.getElementById('chatMsgInput').focus();
}

// Auto-open chat after 8 seconds if user hasn't opened it
setTimeout(() => {
  if (!chatOpen) {
    // Show a teaser message above the bubble
    const teaser = document.createElement('div');
    teaser.id = 'chatTeaser';
    teaser.style.cssText = 'position:fixed;bottom:96px;right:24px;z-index:9998;padding:12px 18px;border-radius:12px;border-bottom-right-radius:4px;font-size:16px;font-family:Rethink Sans,sans-serif;box-shadow:0 4px 16px rgba(0,0,0,0.2);cursor:pointer;max-width:260px;animation:chatSlideUp .3s ease;'
      + '{% if (page.color_scheme or "dark") == "light" %}background:#fff;color:#1e293b{% else %}background:#1e293b;color:#e2e8f0{% endif %}';
    teaser.innerHTML = 'Got questions? I\'m here to help! ðŸ‘‹';
    teaser.onclick = () => { teaser.remove(); toggleChat(); };
    document.body.appendChild(teaser);
    // Auto-dismiss teaser after 6 seconds
    setTimeout(() => { if (document.getElementById('chatTeaser')) document.getElementById('chatTeaser').remove(); }, 6000);
  }
}, 8000);
</script>

<script src="/static/js/section-templates.js"></script>
<script>
const sections = (() => { try { return JSON.parse({{ page.body_copy | tojson }}); } catch(e) { return []; } })();
const accent = '{{ page.accent_color or "#38bdf8" }}';
const scheme = '{{ page.color_scheme or "dark" }}';

const el = document.getElementById('pageContent');
if (sections.length > 0) {
  let html = '';
  sections.forEach(sec => {
    const tpl = SECTION_TEMPLATES.find(t => t.id === sec.templateId);
    if (tpl) html += tpl.render(sec.data, accent, scheme);
  });
  el.innerHTML = html;
} else {
  // Fallback for old-format pages (non-section based)
  const h = '{{ page.headline | default("", true) }}';
  const sub = '{{ page.subheadline | default("", true) }}';
  const cta = '{{ page.cta_text | default("", true) }}';
  const url = '{{ page.cta_url | default("#", true) }}';
  const tc = scheme==='light'?'#0f172a':'#fff';
  const sc = scheme==='light'?'#4a5a6e':'rgba(255,255,255,0.65)';
  el.innerHTML = `<div style="text-align:center;padding:72px 32px;max-width:720px;margin:0 auto"><h1 style="font-size:clamp(32px,5vw,48px);font-weight:800;color:${tc};margin-bottom:16px">${h}</h1><p style="font-size:19px;color:${sc};margin-bottom:36px">${sub}</p>${cta?`<a href="${url}" style="display:inline-block;padding:18px 48px;background:${accent};color:#fff;font-size:19px;font-weight:800;border-radius:12px;text-decoration:none">${cta}</a>`:''}</div>`;
}

// Track page view
fetch('/api/funnels/track-click/{{ page.id }}').catch(()=>{});
</script>
</body>
</html>
