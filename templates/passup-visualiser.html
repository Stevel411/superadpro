<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pass-Up Visualiser — SuperAdPro</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@700;800&family=DM+Sans:wght@400;500;600;700;800&family=Rethink+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--cyan:#38bdf8;--cyan2:#0ea5e9;--green:#10b981;--gold:#f59e0b;--bg:#f0f2f8;--border:#e2e8f0}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans','Rethink Sans',sans-serif;background:var(--bg);color:#0f172a;min-height:100vh;overflow-x:hidden}

/* ── Top Bar ── */
.topbar{position:sticky;top:0;z-index:100;background:#0a0a1a;border-bottom:1px solid rgba(14,165,233,0.12);padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between}
.topbar-back{display:flex;align-items:center;gap:8px;color:#6b7d94;font-size:14px;font-weight:600;text-decoration:none;padding:7px 14px;border-radius:8px;border:1px solid rgba(148,163,184,0.15);transition:all 0.2s}
.topbar-back:hover{border-color:rgba(56,189,248,0.4);color:#38bdf8;background:rgba(56,189,248,0.08)}
.topbar-brand{display:flex;align-items:center;gap:10px;text-decoration:none}
.topbar-brand b{font-family:Sora,sans-serif;font-size:18px;font-weight:800;color:#fff}
.topbar-brand b em{font-style:normal;color:#38bdf8}

/* ── Hero ── */
.hero{text-align:center;padding:36px 40px 24px;background:linear-gradient(135deg,#0284c7 0%,#0ea5e9 40%,#38bdf8 100%);border-radius:0 0 24px 24px;margin-bottom:20px}
.hero-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:999px;padding:6px 18px;font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#fff;margin-bottom:16px}
.hero-badge::before{content:'';width:6px;height:6px;border-radius:50%;background:#fff;animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
.hero h1{font-family:Sora,sans-serif;font-size:clamp(22px,3.5vw,36px);font-weight:800;line-height:1.15;color:#fff;margin-bottom:8px}
.hero h1 span{color:#e0f2fe}
.hero p{font-size:15px;color:rgba(255,255,255,0.7);max-width:560px;margin:0 auto;line-height:1.6}

/* ── Tier bar ── */
.tier-bar{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;padding:14px 24px;background:#fff;border:1px solid var(--border);border-radius:14px;max-width:1200px;margin:0 auto 20px;box-shadow:0 1px 3px rgba(0,0,0,0.03)}
.tier-btn{padding:8px 18px;border-radius:10px;border:none;background:transparent;color:#64748b;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s}
.tier-btn:hover{color:#0ea5e9;background:rgba(14,165,233,0.05)}
.tier-btn.active{background:linear-gradient(135deg,#0ea5e9,#38bdf8);color:#fff;box-shadow:0 4px 14px rgba(14,165,233,0.3)}

/* ── Layout ── */
.main{display:grid;grid-template-columns:1fr 340px;gap:20px;max-width:1200px;margin:0 auto;padding:0 24px 80px}
@media(max-width:960px){.main{grid-template-columns:1fr}}

/* ── Cards ── */
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:22px;box-shadow:0 1px 4px rgba(0,40,100,0.04)}
.card-eye{font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:#38bdf8;margin-bottom:4px}
.card-ttl{font-size:17px;font-weight:800;color:#0f172a;margin-bottom:14px}

/* ── Controls ── */
.ctrls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
.btn{padding:10px 20px;border-radius:8px;border:none;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s}
.btn-play{background:linear-gradient(135deg,#0ea5e9,#38bdf8);color:#fff;box-shadow:0 4px 14px rgba(14,165,233,0.3)}
.btn-play:hover{box-shadow:0 6px 24px rgba(0,212,255,0.4);transform:translateY(-1px)}
.btn-rst{background:#f8fafc;color:#64748b;border:1px solid var(--border)}
.btn-rst:hover{background:#f1f5f9;color:#0f172a}
.spd{display:flex;align-items:center;gap:8px;margin-left:auto}
.spd span{font-size:10px;color:#94a3b8;letter-spacing:1px;text-transform:uppercase}
input[type=range]{width:80px;accent-color:var(--cyan2);cursor:pointer}

/* ═══ TREE — centred, compact ═══ */
.tree-viewport{position:relative;overflow:hidden;border:1px solid var(--border);border-radius:12px;background:#f8fafc;margin-bottom:16px}
.tree-canvas{position:relative;min-height:340px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 16px}
.tree-canvas svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
.tree-rows{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:28px}
.tree-row{display:flex;justify-content:center;gap:10px}

/* Row labels */
.row-label{position:absolute;left:8px;font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#94a3b8;top:50%;transform:translateY(-50%);white-space:nowrap}

/* Nodes */
.nd{
  width:68px;height:56px;border-radius:10px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  text-align:center;position:relative;cursor:default;
  background:#fff;border:1.5px dashed #e2e8f0;color:#64748b;
  transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);overflow:visible;
}
.nd .nm{font-size:11px;font-weight:800;line-height:1.1;color:#334155}
.nd .sc{font-size:9px;font-weight:600;color:#94a3b8;margin-top:2px}
.nd .badge{position:absolute;top:-7px;right:-7px;width:16px;height:16px;border-radius:50%;font-size:8px;font-weight:800;display:none;align-items:center;justify-content:center;z-index:3;line-height:1;box-shadow:0 2px 6px rgba(0,0,0,0.15)}

/* Root */
.nd.root{
  background:linear-gradient(135deg,#0ea5e9,#0284c7);border:2.5px solid var(--cyan);color:#fff;
  width:80px;height:64px;border-style:solid;
  box-shadow:0 4px 20px rgba(14,165,233,0.35),0 0 0 4px rgba(14,165,233,0.1);
}
.nd.root .nm{font-size:15px;color:#fff;font-family:Sora,sans-serif}
.nd.root .sc{color:rgba(255,255,255,0.7)}

/* States */
.nd.active{background:#f0f9ff;border:1.5px solid rgba(14,165,233,0.3);border-style:solid;color:#0f172a}
.nd.selling{border-color:#10b981!important;border-style:solid!important;background:rgba(16,185,129,0.06)!important;box-shadow:0 0 12px rgba(16,185,129,0.15)!important}
.nd.keeping{border-color:#10b981!important;border-style:solid!important;background:linear-gradient(135deg,rgba(16,185,129,0.08),rgba(16,185,129,0.15))!important;box-shadow:0 0 18px rgba(16,185,129,0.25)!important;animation:pulse .45s ease}
.nd.receiving{border-color:var(--gold)!important;border-style:solid!important;background:linear-gradient(135deg,rgba(245,158,11,0.06),rgba(245,158,11,0.12))!important;box-shadow:0 0 18px rgba(245,158,11,0.25)!important;animation:pulse .45s ease}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
.nd.keeping .nm{color:#065f46!important}.nd.receiving .nm{color:#92400e!important}

/* Float */
.cfloat{position:absolute;font-size:13px;font-weight:800;pointer-events:none;z-index:10;white-space:nowrap;left:50%;animation:fUp 1.1s ease-out forwards}
@keyframes fUp{0%{opacity:1;top:-8px;transform:translateX(-50%)}100%{opacity:0;top:-36px;transform:translateX(-50%)}}

/* Flow arrow for pass-up */
.flow-arrow{position:absolute;z-index:5;pointer-events:none;animation:flowPulse 0.6s ease-out forwards}
@keyframes flowPulse{0%{opacity:0;transform:scale(0.5)}30%{opacity:1;transform:scale(1.1)}100%{opacity:0;transform:scale(1)}}

/* Legend */
.legend{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
.lg-i{display:flex;align-items:center;gap:6px;font-size:11px;color:#64748b}
.lg-s{width:14px;height:14px;border-radius:4px;flex-shrink:0}

/* ═══ CALCULATOR PANEL ═══ */
.calc-panel{background:rgba(14,165,233,0.03);border:1px solid rgba(14,165,233,0.12);border-radius:12px;padding:18px;margin-bottom:16px}
.calc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.calc-label{font-size:14px;font-weight:700;color:#0f172a}
.calc-sub{font-size:12px;color:#64748b;margin-top:2px}
.calc-big{font-size:36px;font-weight:800;line-height:1}
.calc-cap{font-size:11px;color:#94a3b8}
.calc-slider{width:100%;accent-color:var(--cyan2);margin:8px 0}
.calc-range{display:flex;justify-content:space-between;font-size:10px;color:#94a3b8;margin-bottom:6px}
.calc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
.calc-stat{background:#fff;border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center}
.calc-stat-val{font-size:20px;font-weight:800;margin-bottom:2px}
.calc-stat-lbl{font-size:10px;color:#64748b;font-weight:600}

/* How-strip */
.how-strip{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
@media(max-width:700px){.how-strip{grid-template-columns:repeat(2,1fr)}}
.how-s{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.how-s .hn{width:24px;height:24px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;margin-bottom:5px}
.how-s .ht{font-size:12px;font-weight:700;color:#0f172a;margin-bottom:2px}
.how-s .hd{font-size:10px;color:#64748b;line-height:1.45}

/* ── Right Col ── */
.right-col{display:flex;flex-direction:column;gap:14px}
.eye{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#38bdf8;margin-bottom:12px}
.e-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9}
.e-row:last-child{border-bottom:none}
.e-left{display:flex;align-items:center;gap:10px}
.e-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.e-lbl{font-size:13px;font-weight:600;color:#334155}
.e-sub{font-size:11px;color:#94a3b8;margin-top:1px}
.e-amt{font-size:18px;font-weight:700;text-align:right}
.e-amt.bump{animation:nb .25s ease}
@keyframes nb{0%,100%{transform:scale(1)}50%{transform:scale(1.18)}}

.tot-card{background:linear-gradient(135deg,#0284c7,#0ea5e9,#38bdf8);border:none;border-radius:14px;padding:20px;text-align:center;color:#fff}
.tot-lbl{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:4px}
.tot-amt{font-size:32px;font-weight:800;color:#fff}
.tot-sub{font-size:12px;color:rgba(255,255,255,0.55);margin-top:4px}

/* Split */
.sp-bar{display:flex;height:8px;border-radius:99px;overflow:hidden;gap:2px;margin:10px 0 12px}
.sp-seg{border-radius:3px}
.sp-leg{display:flex;flex-direction:column;gap:6px}
.sp-i{display:flex;align-items:center;gap:8px;font-size:12px;color:#64748b}
.sp-sw{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.sp-v{margin-left:auto;font-weight:700}

/* Info */
.i-ttl{font-size:13px;font-weight:700;color:#0f172a;margin-bottom:10px}
.i-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f1f5f9;font-size:12px}
.i-row:last-child{border-bottom:none}
.i-k{color:#64748b}.i-v{font-weight:700}

/* Log */
.log-ls{display:flex;flex-direction:column;max-height:200px;overflow-y:auto}
.log-it{display:flex;align-items:center;font-size:11px;color:#64748b;padding:4px 0;border-bottom:1px solid #f8fafc;animation:sIn .2s ease}
.log-it:last-child{border-bottom:none}
@keyframes sIn{from{opacity:0;transform:translateX(-4px)}to{opacity:1;transform:none}}
.log-l{display:flex;align-items:center;gap:6px;min-width:0}
.log-w{font-weight:700;color:#334155;min-width:36px}
.log-s{color:#94a3b8;font-size:10px}
.log-t{font-size:8px;padding:2px 5px;border-radius:3px;font-weight:700;letter-spacing:.5px;white-space:nowrap}
.log-t.kept{color:#10b981;border:1px solid rgba(16,185,129,.25);background:rgba(16,185,129,.06)}
.log-t.passup{color:var(--gold);border:1px solid rgba(245,158,11,.25);background:rgba(245,158,11,.06)}
.log-a{font-weight:700;font-size:11px;white-space:nowrap;margin-left:auto;font-variant-numeric:tabular-nums}

/* Mobile */
.mob-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(2,8,24,.97);border-top:1px solid rgba(14,165,233,.12);z-index:200;backdrop-filter:blur(12px);padding:6px 0 max(6px,env(safe-area-inset-bottom))}
.mob-nav-in{display:flex;justify-content:space-around;max-width:480px;margin:0 auto}
.mob-i{display:flex;flex-direction:column;align-items:center;gap:2px;text-decoration:none;padding:4px 8px;font-size:10px;color:#64748b}
.mob-i.on{color:#38bdf8}
@media(max-width:768px){.mob-nav{display:block}body{padding-bottom:72px}.main{padding:0 12px 80px;grid-template-columns:1fr}.topbar b{font-size:15px}}
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <a href="/dashboard" class="topbar-back">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
    Dashboard
  </a>
  <a href="/" class="topbar-brand">
    <svg width="32" height="32" viewBox="0 0 44 44"><circle cx="22" cy="22" r="20" fill="url(#sg)"/><path d="M18 13l14 9-14 9V13z" fill="#fff"/><defs><linearGradient id="sg" x1="0" y1="0" x2="44" y2="44" gradientUnits="userSpaceOnUse"><stop stop-color="#0ea5e9"/><stop offset="1" stop-color="#38bdf8"/></linearGradient></defs></svg>
    <b>Super<em>Ad</em>Pro</b>
  </a>
</div>

<!-- Hero -->
<div class="hero">
  <div class="hero-badge">Stream 03 — Course Commissions</div>
  <h1>Infinite Pass-Up <span>Visualiser</span></h1>
  <p>Watch 100% course commissions cascade through your team. Your <strong style="color:#fff">2nd, 4th &amp; 6th</strong> sales pass up — everything else you keep forever.</p>
</div>

<!-- Tier Bar -->
<div class="tier-bar">
  <button class="tier-btn active" data-price="100" onclick="selTier(this)">$100 Starter</button>
  <button class="tier-btn" data-price="300" onclick="selTier(this)">$300 Advanced</button>
  <button class="tier-btn" data-price="500" onclick="selTier(this)">$500 Elite</button>
</div>

<div class="main">
  <!-- ═══ LEFT ═══ -->
  <div class="card">
    <div class="card-eye">Stream 03 — Course Pass-Up</div>
    <div class="card-ttl" id="panelTtl">INFINITE PASS-UP — $100 STARTER</div>

    <div class="ctrls">
      <button class="btn btn-play" id="playBtn" onclick="togglePlay()">▶ PLAY</button>
      <button class="btn btn-rst" onclick="resetSim()">↺ RESET</button>
      <div class="spd"><span>Speed</span><input type="range" min="1" max="5" value="3" id="spdSlider"></div>
    </div>

    <!-- TREE — focused 3-level view -->
    <div class="tree-viewport">
      <div class="tree-canvas" id="treeCanvas">
        <svg id="treeSvg" width="100%" height="100%"></svg>
        <div class="tree-rows" id="treeRows"></div>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend">
      <div class="lg-i"><div class="lg-s" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);border:2px solid var(--cyan)"></div>You (Root)</div>
      <div class="lg-i"><div class="lg-s" style="background:#f0f9ff;border:1.5px solid rgba(14,165,233,.3)"></div>Active Member</div>
      <div class="lg-i"><div class="lg-s" style="background:rgba(16,185,129,.12);border:1.5px solid var(--green)"></div>Keeps Commission</div>
      <div class="lg-i"><div class="lg-s" style="background:rgba(245,158,11,.1);border:1.5px solid var(--gold)"></div>Pass-Up to Sponsor</div>
    </div>

    <!-- Earnings Calculator -->
    <div class="calc-panel">
      <div class="calc-top">
        <div>
          <div class="calc-label">Your Direct Referrals</div>
          <div class="calc-sub">Each referral sells courses &amp; their team pass up to you</div>
        </div>
        <div style="text-align:right">
          <div class="calc-big" id="calcDirectBig" style="color:var(--green)">6</div>
          <div class="calc-cap">personal referrals</div>
        </div>
      </div>
      <input type="range" class="calc-slider" min="1" max="20" value="6" id="calcDirect" oninput="updateCalc()">
      <div class="calc-range"><span>1 referral</span><span>10 referrals</span><span>20 referrals</span></div>

      <div class="calc-top" style="margin-top:10px">
        <div>
          <div class="calc-label">Avg Sales Per Member</div>
          <div class="calc-sub">How many course sales each person in your team makes</div>
        </div>
        <div style="text-align:right">
          <div class="calc-big" id="calcSalesBig" style="color:var(--cyan2)">6</div>
          <div class="calc-cap">sales each</div>
        </div>
      </div>
      <input type="range" class="calc-slider" min="1" max="12" value="6" id="calcSales" oninput="updateCalc()">
      <div class="calc-range"><span>1 sale</span><span>6 sales</span><span>12 sales</span></div>

      <div class="calc-grid">
        <div class="calc-stat"><div class="calc-stat-val" id="csKept" style="color:var(--green)">$0</div><div class="calc-stat-lbl">You Keep (1,3,5,7+)</div></div>
        <div class="calc-stat"><div class="calc-stat-val" id="csPassup" style="color:var(--gold)">$0</div><div class="calc-stat-lbl">Pass-Ups Received</div></div>
        <div class="calc-stat"><div class="calc-stat-val" id="csTotal" style="color:var(--cyan2)">$0</div><div class="calc-stat-lbl">Total Estimated</div></div>
        <div class="calc-stat"><div class="calc-stat-val" id="csTeam" style="color:#334155">0</div><div class="calc-stat-lbl">Total Team Size</div></div>
      </div>
    </div>

    <!-- How it works -->
    <div class="how-strip">
      <div class="how-s"><div class="hn" style="background:rgba(14,165,233,.1);color:var(--cyan2)">1</div><div class="ht">Refer &amp; Sell</div><div class="hd">Refer someone who buys a course — that's your sale</div></div>
      <div class="how-s"><div class="hn" style="background:rgba(16,185,129,.1);color:var(--green)">2</div><div class="ht">Keep 100%</div><div class="hd">Sales 1, 3, 5, 7+ you keep the full commission</div></div>
      <div class="how-s"><div class="hn" style="background:rgba(245,158,11,.1);color:var(--gold)">3</div><div class="ht">Pass Up 3</div><div class="hd">Your 2nd, 4th &amp; 6th sales pass 100% to your sponsor</div></div>
      <div class="how-s"><div class="hn" style="background:rgba(124,58,237,.1);color:#8b5cf6">4</div><div class="ht">Infinite Depth</div><div class="hd">Pass-ups cascade through every level of your team</div></div>
    </div>
  </div>

  <!-- ═══ RIGHT ═══ -->
  <div class="right-col">
    <div class="card">
      <div class="eye">Live Earnings Tracker</div>
      <div class="e-row">
        <div class="e-left"><div class="e-dot" style="background:var(--green)"></div><div><div class="e-lbl">Direct Sales Kept</div><div class="e-sub">Your sales 1, 3, 5, 7+</div></div></div>
        <div class="e-amt" id="keptAmt" style="color:#10b981">$0</div>
      </div>
      <div class="e-row">
        <div class="e-left"><div class="e-dot" style="background:var(--gold)"></div><div><div class="e-lbl">Pass-Ups Received</div><div class="e-sub">Team's 2nd, 4th, 6th</div></div></div>
        <div class="e-amt" id="passupAmt" style="color:var(--gold)">$0</div>
      </div>
    </div>

    <div class="tot-card">
      <div class="tot-lbl">Your Total This Round</div>
      <div class="tot-amt" id="totalAmt">$0</div>
      <div class="tot-sub"><span id="kc">0</span> kept · <span id="pc">0</span> pass-ups</div>
    </div>

    <div class="card">
      <div class="eye">Per Sale — $<span id="spPrice">100</span></div>
      <div class="sp-bar"><div class="sp-seg" style="flex:4;background:var(--green)"></div><div class="sp-seg" style="flex:3;background:var(--gold)"></div></div>
      <div class="sp-leg">
        <div class="sp-i"><div class="sp-sw" style="background:var(--green)"></div>You keep (1,3,5,7+)<span class="sp-v" id="spK" style="color:#10b981">$100</span></div>
        <div class="sp-i"><div class="sp-sw" style="background:var(--gold)"></div>Passes up (2,4,6)<span class="sp-v" id="spP" style="color:var(--gold)">$100</span></div>
      </div>
    </div>

    <div class="card">
      <div class="i-ttl">Simulation Stats</div>
      <div class="i-row"><span class="i-k">Course tier</span><span class="i-v" id="iTier" style="color:var(--cyan2)">$100 Starter</span></div>
      <div class="i-row"><span class="i-k">Total team sales</span><span class="i-v" id="iTotal" style="color:var(--cyan2)">0</span></div>
      <div class="i-row"><span class="i-k">Your personal sales</span><span class="i-v" id="iDirect" style="color:var(--green)">0</span></div>
      <div class="i-row"><span class="i-k">Pass-ups received</span><span class="i-v" id="iPassups" style="color:var(--gold)">0</span></div>
    </div>

    <div class="card">
      <div class="eye" style="font-size:10px;margin-bottom:8px">Activity Log</div>
      <div class="log-ls" id="logList">
        <div class="log-it"><span style="color:#94a3b8;font-size:11px">Press PLAY to start…</span></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ═══ ENGINE ═══ */
let tier=100;
const PU=new Set([2,4,6]);
const NM=['Alex','Beth','Carl','Dana','Eric','Faye','Gina','Hugo','Iris','Jake','Kate','Leo'];
let nodes=[],nMap={},playing=false,tmr=null,queue=[],qi=0;
let tK=0,tP=0,nK=0,nP=0,tS=0;

/* Tree: YOU → 4 directs → each has 2 = 13 nodes total — fits perfectly centred */
function buildTree(){
  nodes=[];nMap={};let id=0,ni=0;
  function mk(nm,lv,pid){const n={id:id++,nm,lv,pid,pu:null,sc:0,rc:0,ch:[],el:null};nodes.push(n);nMap[n.id]=n;return n;}
  const r=mk('YOU',0,null);
  for(let i=0;i<4;i++){
    const c=mk(NM[ni++],1,0);r.ch.push(c.id);r.rc++;
    c.pu=PU.has(r.rc)?(r.pu??r.id):r.id;
  }
  for(const cid of r.ch){
    const p=nMap[cid];
    for(let i=0;i<2;i++){
      const c=mk(NM[ni++],2,p.id);p.ch.push(c.id);p.rc++;
      c.pu=PU.has(p.rc)?(p.pu??p.id):p.id;
    }
  }
}

function buildQueue(){
  queue=[];
  for(let r=1;r<=8;r++){
    const b=nodes.filter(n=>n.id>0).map(n=>({sid:n.pid,r}));
    for(let i=b.length-1;i>0;i--){const j=Math.random()*i|0;[b[i],b[j]]=[b[j],b[i]];}
    queue.push(...b);
  }
}

function renderTree(){
  const rows=document.getElementById('treeRows');rows.innerHTML='';
  const lvls=[[],[],[]];nodes.forEach(n=>lvls[n.lv].push(n));
  lvls.forEach((lv,li)=>{
    const row=document.createElement('div');row.className='tree-row';row.style.position='relative';
    lv.forEach(n=>{
      const el=document.createElement('div');
      el.className='nd'+(li===0?' root':'');el.id='n'+n.id;
      el.innerHTML=`<div class="nm">${n.nm}</div><div class="sc" id="sc${n.id}">0 sales</div><div class="badge" id="pb${n.id}"></div>`;
      row.appendChild(el);n.el=el;
    });
    rows.appendChild(row);
  });
  requestAnimationFrame(()=>requestAnimationFrame(drawLines));
}

function drawLines(){
  const svg=document.getElementById('treeSvg');
  const cv=document.getElementById('treeCanvas');
  const cr=cv.getBoundingClientRect();
  svg.setAttribute('width',cv.scrollWidth);svg.setAttribute('height',cv.scrollHeight);svg.innerHTML='';
  nodes.forEach(n=>{
    if(n.pid===null||!n.el)return;const p=nMap[n.pid];if(!p||!p.el)return;
    const pr=p.el.getBoundingClientRect(),nr=n.el.getBoundingClientRect();
    const x1=pr.left+pr.width/2-cr.left,y1=pr.top+pr.height-cr.top;
    const x2=nr.left+nr.width/2-cr.left,y2=nr.top-cr.top;
    const my=(y1+y2)/2;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M${x1},${y1} C${x1},${my} ${x2},${my} ${x2},${y2}`);
    path.setAttribute('fill','none');path.setAttribute('stroke','#cbd5e1');path.setAttribute('stroke-width','1.5');
    path.id=`ln${n.pid}-${n.id}`;svg.appendChild(path);
  });
}

function processSale(){
  if(qi>=queue.length){pause();addLog('✅','','Simulation complete','#38bdf8','kept');return;}
  const s=queue[qi++];const sl=nMap[s.sid];if(!sl){processSale();return;}
  sl.sc++;tS++;const sn=sl.sc;const isUp=PU.has(sn);
  const sce=document.getElementById('sc'+sl.id);if(sce)sce.textContent=sn+(sn===1?' sale':' sales');
  if(sl.el&&!sl.el.classList.contains('root'))sl.el.classList.add('active');

  if(isUp){
    let rid=sl.pu,rec=rid!=null?nMap[rid]:null;if(!rec)rec=nMap[0];
    sl.el.classList.add('selling');setTimeout(()=>sl.el.classList.remove('selling'),600);
    const bd=document.getElementById('pb'+sl.id);
    if(bd){bd.style.display='flex';bd.style.background='var(--gold)';bd.style.color='#fff';bd.textContent='↑';}
    const ln=document.getElementById(`ln${sl.pid}-${sl.id}`);
    if(ln){ln.setAttribute('stroke','#f59e0b');ln.setAttribute('stroke-width','2.5');ln.setAttribute('stroke-dasharray','5 3');}
    rec.el.classList.add('receiving');setTimeout(()=>rec.el.classList.remove('receiving'),700);
    showFloat(rec.el,'+$'+tier,'#f59e0b');
    if(rec.id===0){tP+=tier;nP++;}
    addLog(sl.nm,'#'+sn,'↑ '+rec.nm,'#f59e0b','passup');
  } else {
    sl.el.classList.add('keeping');setTimeout(()=>sl.el.classList.remove('keeping'),500);
    showFloat(sl.el,'+$'+tier,'#10b981');
    const bd=document.getElementById('pb'+sl.id);
    if(bd&&sn<=7){bd.style.display='flex';bd.style.background='var(--green)';bd.style.color='#fff';bd.textContent='✓';}
    if(sl.id===0){tK+=tier;nK++;}
    addLog(sl.nm,'#'+sn,'KEPT ✓','#10b981','kept');
  }
  updateUI();
}

function showFloat(el,t,c){const f=document.createElement('div');f.className='cfloat';f.textContent=t;f.style.color=c;el.appendChild(f);setTimeout(()=>f.remove(),1100);}

function updateUI(){
  bump('keptAmt','$'+tK.toLocaleString());bump('passupAmt','$'+tP.toLocaleString());
  document.getElementById('totalAmt').textContent='$'+(tK+tP).toLocaleString();
  document.getElementById('kc').textContent=nK;document.getElementById('pc').textContent=nP;
  document.getElementById('iTotal').textContent=tS;document.getElementById('iDirect').textContent=nMap[0].sc;
  document.getElementById('iPassups').textContent=nP;
}
function bump(id,v){const e=document.getElementById(id);e.textContent=v;e.classList.remove('bump');void e.offsetWidth;e.classList.add('bump');}

function addLog(who,sale,act,col,type){
  const l=document.getElementById('logList');
  if(l.querySelector('[style*="94a3b8"]'))l.innerHTML='';
  const it=document.createElement('div');it.className='log-it';
  it.innerHTML=`<div class="log-l"><span class="log-w">${who}</span><span class="log-s">${sale}</span><span class="log-t ${type}">${act}</span></div><span class="log-a" style="color:${col}">$${tier}</span>`;
  l.insertBefore(it,l.firstChild);while(l.children.length>12)l.removeChild(l.lastChild);
}

/* Controls */
function togglePlay(){playing?pause():play();}
function play(){playing=true;document.getElementById('playBtn').textContent='⏸ PAUSE';tick();}
function pause(){playing=false;clearTimeout(tmr);document.getElementById('playBtn').textContent='▶ PLAY';}
function getDelay(){return Math.round(800-(parseInt(document.getElementById('spdSlider').value)-1)*160);}
function tick(){if(!playing)return;processSale();if(qi<queue.length)tmr=setTimeout(tick,getDelay());else pause();}

function selTier(btn){
  document.querySelectorAll('.tier-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  tier=parseInt(btn.dataset.price);const lb=tier===100?'STARTER':tier===300?'ADVANCED':'ELITE';
  document.getElementById('panelTtl').textContent='INFINITE PASS-UP — $'+tier+' '+lb;
  document.getElementById('iTier').textContent='$'+tier+' '+lb.charAt(0)+lb.slice(1).toLowerCase();
  document.getElementById('spPrice').textContent=tier;document.getElementById('spK').textContent='$'+tier;document.getElementById('spP').textContent='$'+tier;
  updateCalc();resetSim();
}

function resetSim(){
  pause();tK=0;tP=0;nK=0;nP=0;tS=0;qi=0;
  buildTree();buildQueue();renderTree();updateUI();
  document.getElementById('logList').innerHTML='<div class="log-it"><span style="color:#94a3b8;font-size:11px">Press PLAY to start…</span></div>';
  document.getElementById('playBtn').textContent='▶ PLAY';
}

/* ═══ CALCULATOR ═══ */
function updateCalc(){
  const directs=parseInt(document.getElementById('calcDirect').value);
  const salesPer=parseInt(document.getElementById('calcSales').value);
  document.getElementById('calcDirectBig').textContent=directs;
  document.getElementById('calcSalesBig').textContent=salesPer;

  // Your personal sales: you make salesPer sales
  // You keep 1,3,5,7+ and pass up 2,4,6
  const keptPositions=salesPer-Math.min(salesPer,3); // positions 2,4,6 pass up (max 3)
  let myKept=0;
  for(let i=1;i<=salesPer;i++){if(!PU.has(i))myKept++;}
  const myKeptEarnings=myKept*tier;

  // Pass-ups you receive:
  // Each of your directs makes salesPer sales → their 2,4,6 pass to you
  // That's min(salesPer,6) check which are in {2,4,6}
  let passUpsFromEachDirect=0;
  for(let i=1;i<=salesPer;i++){if(PU.has(i))passUpsFromEachDirect++;}
  const directPassups=directs*passUpsFromEachDirect;

  // L2: each direct has ~directs/2 referrals (conservative), their pass-ups flow up
  // For simplicity: each L1 member has same referral count
  const l2Each=Math.max(1,Math.floor(directs*0.6));
  // L2 members' pass-ups go to their pass-up sponsor
  // Half of L2 members have YOU as pass-up sponsor (the ones who were position 2,4,6 of their parent)
  const l2Total=directs*l2Each;
  const l2PassToYou=Math.floor(l2Total*0.5); // roughly half have you as pass-up sponsor
  let l2Passups=0;
  for(let i=1;i<=salesPer;i++){if(PU.has(i))l2Passups++;}
  const l2PassupEarnings=l2PassToYou*l2Passups;

  const totalPassupEarnings=(directPassups+l2PassupEarnings)*tier;
  const totalEarnings=myKeptEarnings+totalPassupEarnings;
  const teamSize=1+directs+l2Total;

  document.getElementById('csKept').textContent='$'+myKeptEarnings.toLocaleString();
  document.getElementById('csPassup').textContent='$'+totalPassupEarnings.toLocaleString();
  document.getElementById('csTotal').textContent='$'+totalEarnings.toLocaleString();
  document.getElementById('csTeam').textContent=teamSize.toLocaleString();
}

/* Init */
resetSim();updateCalc();
window.addEventListener('resize',()=>requestAnimationFrame(drawLines));
</script>

<div class="mob-nav"><div class="mob-nav-in">
  <a href="/dashboard" class="mob-i">⊞ Home</a>
  <a href="/watch" class="mob-i">▶ Watch</a>
  <a href="/income-grid" class="mob-i">⚡ Grid</a>
  <a href="/wallet" class="mob-i">◎ Wallet</a>
  <a href="/passup-visualiser" class="mob-i on">↑ Pass-Up</a>
</div></div>
</body>
</html>
