<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Page Builder ‚Äî {{ page.title }}</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0e1a;--surface:#111827;--border:rgba(14,165,233,0.1);--blue:#0ea5e9;--blue-dim:rgba(14,165,233,0.08);--text:#e2e8f0;--text-dim:#64748b;--text-bright:#fff;--green:#10b981;--radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh}
.app{display:grid;grid-template-rows:60px 1fr;grid-template-columns:300px 1fr;height:100vh}
.topbar{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:var(--bg);border-bottom:1px solid var(--border)}
.sidebar{overflow-y:auto;background:var(--surface);border-right:1px solid var(--border);scrollbar-width:thin;scrollbar-color:rgba(14,165,233,0.12) transparent}
.preview{overflow-y:auto;background:#1a2035}
.tb-left{display:flex;align-items:center;gap:14px}
.tb-back{color:var(--text-dim);font-size:12px;font-weight:600;text-decoration:none;padding:6px 12px;border-radius:8px;border:1px solid rgba(148,163,184,0.12);transition:all 0.2s;display:flex;align-items:center;gap:5px}
.tb-back:hover{color:#38bdf8;border-color:rgba(56,189,248,0.25)}
.tb-logo{font-family:Sora,sans-serif;font-weight:800;font-size:14px;color:var(--text-bright);display:flex;align-items:center;gap:6px}
.tb-logo b{color:#38bdf8}
.tb-sep{width:1px;height:22px;background:var(--border)}
.tb-title{font-family:Sora,sans-serif;font-size:13px;font-weight:700;color:#38bdf8}
.tb-center{display:flex;align-items:center;gap:10px}
.tb-page-name{background:var(--blue-dim);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-weight:500;font-family:inherit;padding:6px 14px;width:220px}
.tb-page-name:focus{outline:none;border-color:rgba(14,165,233,0.4)}
.tb-page-name::placeholder{color:var(--text-dim)}
.tb-status{font-size:11px;color:var(--text-dim);min-width:80px}
.tb-right{display:flex;align-items:center;gap:6px}
.tb-btn{padding:7px 16px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:inherit;transition:all 0.15s}
.btn-preview{background:var(--blue-dim);color:var(--text-dim);border:1px solid var(--border)}.btn-preview:hover{color:#38bdf8;border-color:rgba(14,165,233,0.3)}
.btn-save{background:linear-gradient(135deg,#059669,var(--green));color:#fff}.btn-save:hover{transform:translateY(-1px)}
.btn-publish{background:linear-gradient(135deg,#0284c7,var(--blue));color:#fff}.btn-publish:hover{transform:translateY(-1px)}
.sb-section{border-bottom:1px solid var(--border)}
.sb-header{padding:16px 18px 12px;display:flex;align-items:center;justify-content:space-between}
.sb-title{font-family:Sora,sans-serif;font-size:11px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:#38bdf8}
.sb-subtitle{font-size:11px;color:var(--text-dim)}
.section-list{padding:0 12px 12px}
.section-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1px solid transparent;cursor:pointer;transition:all 0.15s;margin-bottom:4px}
.section-item:hover{background:var(--blue-dim);border-color:var(--border)}
.section-item.active{background:rgba(14,165,233,0.12);border-color:rgba(14,165,233,0.25)}
.si-icon{font-size:18px;width:28px;text-align:center;flex-shrink:0}
.si-name{font-size:13px;font-weight:600;color:var(--text);flex:1}
.si-toggle{width:36px;height:20px;border-radius:10px;background:#334155;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0}
.si-toggle.on{background:var(--blue)}
.si-toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform 0.2s}
.si-toggle.on::after{transform:translateX(16px)}
.si-grip{color:var(--text-dim);cursor:grab;font-size:14px;opacity:0;transition:opacity 0.15s}
.section-item:hover .si-grip{opacity:1}
.editor-panel{padding:14px 18px}
.editor-panel h3{font-family:Sora,sans-serif;font-size:13px;font-weight:700;color:var(--text-bright);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.field{margin-bottom:14px}
.field label{display:block;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);margin-bottom:5px}
.field input,.field textarea,.field select{width:100%;padding:9px 12px;background:rgba(14,165,233,0.04);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;transition:border-color 0.2s}
.field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:rgba(14,165,233,0.4)}
.field textarea{resize:vertical;min-height:60px}
.colour-swatches{display:flex;gap:6px;flex-wrap:wrap}
.swatch{width:32px;height:32px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.15s;position:relative}
.swatch:hover{transform:scale(1.1)}
.swatch.active{border-color:#fff;box-shadow:0 0 0 2px var(--blue)}
.swatch::after{content:'‚úì';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:700;opacity:0}
.swatch.active::after{opacity:1}
.add-section-btn{display:flex;align-items:center;justify-content:center;gap:6px;width:calc(100% - 24px);margin:8px 12px 16px;padding:10px;border-radius:10px;border:1px dashed rgba(14,165,233,0.2);background:transparent;color:var(--text-dim);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s}
.add-section-btn:hover{border-color:rgba(14,165,233,0.4);color:#38bdf8;background:var(--blue-dim)}
.add-dropdown{display:none;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:6px;margin:0 12px 12px;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.add-dropdown.open{display:block}
.add-opt{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text);transition:all 0.15s}
.add-opt:hover{background:var(--blue-dim);color:#38bdf8}
.add-opt span{font-size:16px}
.preview-frame{width:100%;max-width:820px;margin:0 auto;min-height:100%}
.live-preview{padding:20px}
.prev-section{position:relative;border:2px solid transparent;border-radius:8px;transition:border-color 0.2s;cursor:pointer;margin-bottom:2px}
.prev-section:hover{border-color:rgba(14,165,233,0.2)}
.prev-section.active{border-color:rgba(14,165,233,0.5);box-shadow:0 0 0 4px rgba(14,165,233,0.08)}
.prev-section.disabled{opacity:0.3;pointer-events:none}
.prev-section .edit-hint{position:absolute;top:8px;right:8px;background:rgba(14,165,233,0.9);color:#fff;font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;opacity:0;transition:opacity 0.2s;pointer-events:none;z-index:5}
.prev-section:hover .edit-hint{opacity:1}
.device-toggle{display:flex;background:var(--blue-dim);border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.device-toggle button{padding:5px 10px;border:none;background:transparent;color:var(--text-dim);font-size:14px;cursor:pointer;transition:all 0.15s}
.device-toggle button.active{background:var(--blue);color:#fff}
.sidebar::-webkit-scrollbar,.preview::-webkit-scrollbar{width:5px}
.sidebar::-webkit-scrollbar-thumb,.preview::-webkit-scrollbar-thumb{background:rgba(14,165,233,0.12);border-radius:10px}
.del-btn{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(239,68,68,0.2);background:rgba(239,68,68,0.06);color:#f87171;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;margin-top:8px;transition:all 0.15s}
.del-btn:hover{background:rgba(239,68,68,0.12);border-color:rgba(239,68,68,0.4)}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="tb-left">
      <a href="/funnels" class="tb-back">‚Üê Funnels</a>
      <div class="tb-sep"></div>
      <div class="tb-logo"><svg style="width:18px;height:18px" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="16" fill="#0ea5e9"/><path d="M13 10.5L22 16L13 21.5V10.5Z" fill="white"/></svg>Super<b>Ad</b>Pro</div>
      <div class="tb-sep"></div>
      <div class="tb-title">Page Builder</div>
    </div>
    <div class="tb-center">
      <input type="text" class="tb-page-name" id="pageName" value="{{ page.title }}" placeholder="Page name...">
      <span class="tb-status" id="saveStatus"></span>
    </div>
    <div class="tb-right">
      <div class="device-toggle">
        <button class="active" onclick="setDevice('desktop',this)" title="Desktop">üñ•</button>
        <button onclick="setDevice('tablet',this)" title="Tablet">üì±</button>
        <button onclick="setDevice('mobile',this)" title="Mobile">üì≤</button>
      </div>
      <button class="tb-btn btn-preview" onclick="previewPage()">üëÅ Preview</button>
      <button class="tb-btn btn-save" onclick="savePage()">üíæ Save</button>
      <button class="tb-btn btn-publish" onclick="savePage(true)">üöÄ Publish</button>
    </div>
  </div>
  <div class="sidebar" id="sidebar">
    <div class="sb-section">
      <div class="sb-header"><div class="sb-title">Sections</div><div class="sb-subtitle">Click to edit ¬∑ Drag to reorder</div></div>
      <div class="section-list" id="sectionList"></div>
      <button class="add-section-btn" onclick="toggleAddDropdown()">+ Add Section</button>
      <div class="add-dropdown" id="addDropdown">
        <div class="add-opt" onclick="addSection('hero')"><span>üöÄ</span> Hero Section</div>
        <div class="add-opt" onclick="addSection('video')"><span>üé¨</span> Video Hero</div>
        <div class="add-opt" onclick="addSection('features')"><span>‚ú®</span> Features Grid</div>
        <div class="add-opt" onclick="addSection('benefits')"><span>üíé</span> Benefits List</div>
        <div class="add-opt" onclick="addSection('testimonials')"><span>‚≠ê</span> Testimonials</div>
        <div class="add-opt" onclick="addSection('cta')"><span>üî•</span> Call to Action</div>
        <div class="add-opt" onclick="addSection('optin')"><span>üìß</span> Opt-In Form</div>
        <div class="add-opt" onclick="addSection('pricing')"><span>üí≤</span> Pricing Card</div>
        <div class="add-opt" onclick="addSection('guarantee')"><span>üõ°</span> Guarantee Box</div>
        <div class="add-opt" onclick="addSection('faq')"><span>‚ùì</span> FAQ Section</div>
        <div class="add-opt" onclick="addSection('footer')"><span>üìã</span> Footer</div>
      </div>
    </div>
    <div class="sb-section" id="editorPanel" style="display:none">
      <div class="editor-panel" id="editorContent"></div>
    </div>
    <div class="sb-section">
      <div class="sb-header"><div class="sb-title">Theme</div></div>
      <div class="editor-panel">
        <div class="field"><label>Colour Scheme</label>
          <div class="colour-swatches" id="colourSwatches">
            <div class="swatch active" style="background:linear-gradient(135deg,#0a0a1a,#1a1a4a)" data-theme="dark-blue" onclick="setTheme(this)"></div>
            <div class="swatch" style="background:linear-gradient(135deg,#0f172a,#1e293b)" data-theme="slate" onclick="setTheme(this)"></div>
            <div class="swatch" style="background:linear-gradient(135deg,#0c4a6e,#0369a1)" data-theme="ocean" onclick="setTheme(this)"></div>
            <div class="swatch" style="background:linear-gradient(135deg,#1e1b4b,#312e81)" data-theme="purple" onclick="setTheme(this)"></div>
            <div class="swatch" style="background:linear-gradient(135deg,#052e16,#166534)" data-theme="emerald" onclick="setTheme(this)"></div>
            <div class="swatch" style="background:#ffffff;border:1px solid #e2e8f0" data-theme="light" onclick="setTheme(this)"></div>
          </div>
        </div>
        <div class="field"><label>Accent Colour</label>
          <div class="colour-swatches" id="accentSwatches">
            <div class="swatch active" style="background:#0ea5e9" data-accent="#0ea5e9" onclick="setAccent(this)"></div>
            <div class="swatch" style="background:#8b5cf6" data-accent="#8b5cf6" onclick="setAccent(this)"></div>
            <div class="swatch" style="background:#f59e0b" data-accent="#f59e0b" onclick="setAccent(this)"></div>
            <div class="swatch" style="background:#10b981" data-accent="#10b981" onclick="setAccent(this)"></div>
            <div class="swatch" style="background:#ef4444" data-accent="#ef4444" onclick="setAccent(this)"></div>
            <div class="swatch" style="background:#ec4899" data-accent="#ec4899" onclick="setAccent(this)"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="preview" id="previewArea">
    <div class="preview-frame" id="previewFrame"><div class="live-preview" id="livePreview"></div></div>
  </div>
</div>
<script>
const PAGE_ID={{page.id}},PAGE_SLUG="{{page.slug}}";
let currentStatus="{{page.status}}",currentTheme='dark-blue',currentAccent='#0ea5e9',activeSection=null;

const DEFAULTS={
  hero:{icon:'üöÄ',name:'Hero Section',fields:{headline:'Your Headline Goes Here',subheadline:'A compelling subheadline that explains the value proposition and gets visitors excited.',cta_text:'Get Started Now ‚Üí',cta_url:'#'}},
  video:{icon:'üé¨',name:'Video Hero',fields:{headline:'Watch This Short Video',subheadline:'See exactly how this system works in under 3 minutes.',video_url:'https://www.youtube.com/embed/dQw4w9WgXcQ',cta_text:'Yes, I Want In ‚Üí',cta_url:'#'}},
  features:{icon:'‚ú®',name:'Features Grid',fields:{heading:'Why Choose Us',f1_icon:'üöÄ',f1_title:'Feature One',f1_desc:'Brief description of this feature.',f2_icon:'üí∞',f2_title:'Feature Two',f2_desc:'Brief description of this feature.',f3_icon:'‚ö°',f3_title:'Feature Three',f3_desc:'Brief description of this feature.'}},
  benefits:{icon:'üíé',name:'Benefits List',fields:{heading:'What You Get',b1:'Complete access to the full platform and all tools',b2:'Three separate income streams that all stack',b3:'AI-powered marketing suite built into your dashboard',b4:'Instant commissions ‚Äî no waiting for pay day',b5:'Dedicated support and training resources'}},
  testimonials:{icon:'‚≠ê',name:'Testimonials',fields:{heading:'What People Are Saying',t1_text:'This completely changed my approach. Within 30 days I saw real results.',t1_name:'Sarah K.',t2_text:'Finally a system that delivers. Highly recommended.',t2_name:'Mike R.'}},
  cta:{icon:'üî•',name:'Call to Action',fields:{headline:'Ready to Get Started?',subheadline:'Join thousands building their future with us.',cta_text:'Claim Your Spot Now ‚Üí',cta_url:'#'}},
  optin:{icon:'üìß',name:'Opt-In Form',fields:{headline:'Get Instant Access',subheadline:'Enter your details below to get started.',cta_text:'Send Me The Free Guide ‚Üí',privacy_text:'We respect your privacy. Unsubscribe any time.'}},
  pricing:{icon:'üí≤',name:'Pricing Card',fields:{plan_name:'Premium Access',price:'97',price_type:'one-time payment',p1:'Full course access',p2:'Private community',p3:'Weekly live calls',p4:'Lifetime updates',cta_text:'Buy Now ‚Üí',cta_url:'#'}},
  guarantee:{icon:'üõ°',name:'Guarantee Box',fields:{headline:'30-Day Money-Back Guarantee',description:'Try everything risk-free. Not satisfied? Full refund, no questions asked.'}},
  faq:{icon:'‚ùì',name:'FAQ Section',fields:{heading:'Frequently Asked Questions',q1:'How does this work?',a1:'Our platform connects advertisers with engaged viewers. You earn through three stacking income streams.',q2:'How much can I earn?',a2:'Earnings depend on your activity and network. Our comp plan pays 95% back with no caps.',q3:'Is there a guarantee?',a3:'Yes ‚Äî full 30-day money-back guarantee. Try it risk-free.'}},
  footer:{icon:'üìã',name:'Footer',fields:{company:'SuperAdPro',year:'2026',link1_text:'Privacy',link1_url:'#',link2_text:'Terms',link2_url:'#'}}
};

let pageSections=[];
const THEMES={
  'dark-blue':{bg:'linear-gradient(180deg,#0a0a1a 0%,#0f1232 50%,#0a0a2a 100%)',text:'#fff',dim:'rgba(255,255,255,0.6)',card:'rgba(255,255,255,0.05)',cb:'rgba(255,255,255,0.08)'},
  'slate':{bg:'linear-gradient(180deg,#0f172a,#1e293b)',text:'#fff',dim:'rgba(255,255,255,0.6)',card:'rgba(255,255,255,0.05)',cb:'rgba(255,255,255,0.08)'},
  'ocean':{bg:'linear-gradient(180deg,#0c4a6e,#0e5a82,#064e73)',text:'#fff',dim:'rgba(224,242,254,0.7)',card:'rgba(255,255,255,0.08)',cb:'rgba(255,255,255,0.12)'},
  'purple':{bg:'linear-gradient(180deg,#1e1b4b,#2e2970,#1e1b4b)',text:'#fff',dim:'rgba(196,181,253,0.7)',card:'rgba(255,255,255,0.06)',cb:'rgba(255,255,255,0.1)'},
  'emerald':{bg:'linear-gradient(180deg,#052e16,#064e22,#052e16)',text:'#fff',dim:'rgba(209,250,229,0.7)',card:'rgba(255,255,255,0.06)',cb:'rgba(255,255,255,0.1)'},
  'light':{bg:'#ffffff',text:'#0f172a',dim:'#64748b',card:'#f8fafc',cb:'#e2e8f0'}
};

function renderHTML(sec){
  const T=THEMES[currentTheme]||THEMES['dark-blue'],A=currentAccent,f=sec.fields;
  switch(sec.type){
    case 'hero':return `<section style="padding:80px 32px;text-align:center;background:${T.bg};font-family:DM Sans,sans-serif"><h1 style="font-family:Sora,sans-serif;font-size:44px;font-weight:800;color:${T.text};margin-bottom:16px;line-height:1.15">${f.headline}</h1><p style="font-size:17px;color:${T.dim};max-width:580px;margin:0 auto 32px;line-height:1.7">${f.subheadline}</p><a href="${f.cta_url}" style="display:inline-block;padding:16px 40px;background:${A};color:#fff;border-radius:12px;font-weight:700;font-size:16px;text-decoration:none">${f.cta_text}</a></section>`;
    case 'video':return `<section style="padding:60px 32px;text-align:center;background:${T.bg};font-family:DM Sans,sans-serif"><h1 style="font-family:Sora,sans-serif;font-size:40px;font-weight:800;color:${T.text};margin-bottom:10px">${f.headline}</h1><p style="font-size:16px;color:${T.dim};margin-bottom:28px">${f.subheadline}</p><div style="max-width:680px;margin:0 auto 28px;aspect-ratio:16/9;border-radius:14px;overflow:hidden;border:1px solid ${T.cb}"><iframe src="${f.video_url}" style="width:100%;height:100%;border:none" allowfullscreen></iframe></div><a href="${f.cta_url}" style="display:inline-block;padding:16px 40px;background:${A};color:#fff;border-radius:12px;font-weight:700;font-size:16px;text-decoration:none">${f.cta_text}</a></section>`;
    case 'features':return `<section style="padding:60px 32px;background:${T.card};font-family:DM Sans,sans-serif"><div style="max-width:780px;margin:0 auto;text-align:center"><h2 style="font-family:Sora,sans-serif;font-size:30px;font-weight:800;color:${T.text};margin-bottom:40px">${f.heading}</h2><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px">${[1,2,3].map(n=>`<div style="padding:24px;border-radius:14px;border:1px solid ${T.cb};background:${T.card}"><div style="font-size:32px;margin-bottom:10px">${f['f'+n+'_icon']}</div><h3 style="font-size:15px;font-weight:700;color:${T.text};margin-bottom:6px">${f['f'+n+'_title']}</h3><p style="font-size:13px;color:${T.dim};line-height:1.6">${f['f'+n+'_desc']}</p></div>`).join('')}</div></div></section>`;
    case 'benefits':return `<section style="padding:60px 32px;background:${T.bg};font-family:DM Sans,sans-serif"><div style="max-width:600px;margin:0 auto"><h2 style="font-family:Sora,sans-serif;font-size:28px;font-weight:800;color:${T.text};margin-bottom:28px;text-align:center">${f.heading}</h2>${[1,2,3,4,5].map(n=>f['b'+n]?`<div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid ${T.cb}"><span style="color:${A};font-size:18px;flex-shrink:0">‚úì</span><span style="font-size:15px;color:${T.text}">${f['b'+n]}</span></div>`:``).join('')}</div></section>`;
    case 'testimonials':return `<section style="padding:60px 32px;background:${T.card};font-family:DM Sans,sans-serif"><div style="max-width:780px;margin:0 auto;text-align:center"><h2 style="font-family:Sora,sans-serif;font-size:26px;font-weight:800;color:${T.text};margin-bottom:32px">${f.heading}</h2><div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;text-align:left">${[1,2].map(n=>`<div style="background:${T.bg};border:1px solid ${T.cb};border-radius:14px;padding:22px"><p style="font-size:14px;color:${T.dim};line-height:1.7;margin-bottom:14px;font-style:italic">"${f['t'+n+'_text']}"</p><div style="font-size:13px;font-weight:700;color:${A}">‚Äî ${f['t'+n+'_name']}</div></div>`).join('')}</div></div></section>`;
    case 'cta':return `<section style="padding:60px 32px;background:${A};text-align:center;font-family:DM Sans,sans-serif"><h2 style="font-family:Sora,sans-serif;font-size:34px;font-weight:800;color:#fff;margin-bottom:10px">${f.headline}</h2><p style="font-size:16px;color:rgba(255,255,255,0.8);margin-bottom:28px;max-width:480px;margin-left:auto;margin-right:auto">${f.subheadline}</p><a href="${f.cta_url}" style="display:inline-block;padding:16px 44px;background:#fff;color:${A};border-radius:12px;font-weight:800;font-size:16px;text-decoration:none">${f.cta_text}</a></section>`;
    case 'optin':return `<section style="padding:60px 32px;background:${T.bg};font-family:DM Sans,sans-serif;text-align:center"><div style="max-width:440px;margin:0 auto"><h2 style="font-family:Sora,sans-serif;font-size:30px;font-weight:800;color:${T.text};margin-bottom:8px">${f.headline}</h2><p style="font-size:15px;color:${T.dim};margin-bottom:24px">${f.subheadline}</p><form style="display:flex;flex-direction:column;gap:10px"><input type="text" placeholder="Your Name" style="padding:14px;border-radius:10px;border:1px solid ${T.cb};background:${T.card};color:${T.text};font-size:14px;font-family:inherit"><input type="email" placeholder="Your Email" style="padding:14px;border-radius:10px;border:1px solid ${T.cb};background:${T.card};color:${T.text};font-size:14px;font-family:inherit"><button type="submit" style="padding:16px;background:${A};color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:800;cursor:pointer;font-family:inherit">${f.cta_text}</button></form><p style="font-size:11px;color:${T.dim};margin-top:12px;opacity:0.6">${f.privacy_text}</p></div></section>`;
    case 'pricing':return `<section style="padding:60px 32px;background:${T.card};font-family:DM Sans,sans-serif;text-align:center"><div style="max-width:380px;margin:0 auto;border:2px solid ${A};border-radius:18px;overflow:hidden"><div style="background:${A};padding:26px;color:#fff"><div style="font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px">${f.plan_name}</div><div style="font-family:Sora,sans-serif;font-size:44px;font-weight:800">$${f.price}</div><div style="font-size:13px;opacity:0.7">${f.price_type}</div></div><div style="padding:24px;text-align:left;background:${T.bg}">${[1,2,3,4].map(n=>f['p'+n]?`<div style="padding:8px 0;font-size:14px;color:${T.text}">‚úì ${f['p'+n]}</div>`:``).join('')}<a href="${f.cta_url}" style="display:block;padding:14px;background:${A};color:#fff;border-radius:10px;font-weight:700;font-size:15px;text-decoration:none;text-align:center;margin-top:16px">${f.cta_text}</a></div></div></section>`;
    case 'guarantee':return `<section style="padding:48px 32px;background:${T.card};font-family:DM Sans,sans-serif;text-align:center"><div style="max-width:560px;margin:0 auto"><div style="font-size:44px;margin-bottom:12px">üõ°</div><h2 style="font-family:Sora,sans-serif;font-size:22px;font-weight:800;color:${T.text};margin-bottom:10px">${f.headline}</h2><p style="font-size:14px;color:${T.dim};line-height:1.7">${f.description}</p></div></section>`;
    case 'faq':return `<section style="padding:60px 32px;background:${T.bg};font-family:DM Sans,sans-serif"><div style="max-width:640px;margin:0 auto"><h2 style="font-family:Sora,sans-serif;font-size:26px;font-weight:800;color:${T.text};margin-bottom:28px;text-align:center">${f.heading}</h2>${[1,2,3].map(n=>f['q'+n]?`<div style="border-bottom:1px solid ${T.cb};padding:16px 0"><div style="font-size:15px;font-weight:700;color:${T.text};margin-bottom:6px">${f['q'+n]}</div><div style="font-size:14px;color:${T.dim};line-height:1.7">${f['a'+n]}</div></div>`:``).join('')}</div></section>`;
    case 'footer':return `<footer style="padding:28px 32px;background:#0a0a1a;color:rgba(255,255,255,0.35);text-align:center;font-family:DM Sans,sans-serif;font-size:12px"><p>¬© ${f.year} ${f.company}. All rights reserved.</p><p style="margin-top:6px"><a href="${f.link1_url}" style="color:rgba(255,255,255,0.3);text-decoration:none">${f.link1_text}</a> ¬∑ <a href="${f.link2_url}" style="color:rgba(255,255,255,0.3);text-decoration:none">${f.link2_text}</a></p></footer>`;
    default:return '';
  }
}

function renderSectionList(){
  const list=document.getElementById('sectionList');list.innerHTML='';
  pageSections.forEach((sec,i)=>{
    const d=DEFAULTS[sec.type],el=document.createElement('div');
    el.className='section-item'+(activeSection===i?' active':'');el.draggable=true;el.dataset.index=i;
    el.innerHTML=`<span class="si-grip">‚†ø</span><span class="si-icon">${d.icon}</span><span class="si-name">${d.name}</span><div class="si-toggle ${sec.enabled?'on':''}" onclick="event.stopPropagation();toggleSection(${i})"></div>`;
    el.addEventListener('click',()=>selectSection(i));
    el.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',i));
    el.addEventListener('dragover',e=>{e.preventDefault();el.style.borderColor='rgba(14,165,233,0.4)'});
    el.addEventListener('dragleave',()=>{el.style.borderColor='transparent'});
    el.addEventListener('drop',e=>{e.preventDefault();el.style.borderColor='transparent';reorderSection(+e.dataTransfer.getData('text/plain'),i)});
    list.appendChild(el);
  });
}

function renderPreview(){
  const lp=document.getElementById('livePreview');lp.innerHTML='';
  pageSections.forEach((sec,i)=>{
    const wrap=document.createElement('div');
    wrap.className='prev-section'+(activeSection===i?' active':'')+(sec.enabled?'':' disabled');
    wrap.innerHTML='<span class="edit-hint">Click to edit</span>'+renderHTML(sec);
    wrap.addEventListener('click',()=>selectSection(i));lp.appendChild(wrap);
  });
}

function renderEditor(){
  const panel=document.getElementById('editorPanel'),content=document.getElementById('editorContent');
  if(activeSection===null){panel.style.display='none';return;}
  panel.style.display='block';const sec=pageSections[activeSection],d=DEFAULTS[sec.type];
  let html=`<h3>${d.icon} ${d.name}</h3>`;
  Object.entries(sec.fields).forEach(([key,val])=>{
    const label=key.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    const isLong=val.length>60||key.includes('desc')||key.includes('subheadline')||(key.includes('text')&&!key.includes('cta_')&&!key.includes('link'));
    html+=isLong?`<div class="field"><label>${label}</label><textarea data-key="${key}" oninput="updateField('${key}',this.value)">${val}</textarea></div>`:`<div class="field"><label>${label}</label><input type="text" data-key="${key}" value="${val.replace(/"/g,'&quot;')}" oninput="updateField('${key}',this.value)"></div>`;
  });
  html+=`<button class="del-btn" onclick="removeSection(${activeSection})">üóë Remove Section</button>`;
  content.innerHTML=html;
}

function renderAll(){renderSectionList();renderPreview();renderEditor();}
function selectSection(i){activeSection=i;renderAll();document.querySelectorAll('.prev-section')[i]?.scrollIntoView({behavior:'smooth',block:'center'});}
function toggleSection(i){pageSections[i].enabled=!pageSections[i].enabled;renderAll();}
function updateField(key,val){if(activeSection!==null){pageSections[activeSection].fields[key]=val;renderPreview();}}
function reorderSection(from,to){const item=pageSections.splice(from,1)[0];pageSections.splice(to,0,item);if(activeSection===from)activeSection=to;renderAll();}
function addSection(type){pageSections.push({type,enabled:true,fields:{...DEFAULTS[type].fields}});document.getElementById('addDropdown').classList.remove('open');activeSection=pageSections.length-1;renderAll();}
function removeSection(i){pageSections.splice(i,1);activeSection=null;renderAll();}
function toggleAddDropdown(){document.getElementById('addDropdown').classList.toggle('open')}
function setTheme(el){currentTheme=el.dataset.theme;document.querySelectorAll('#colourSwatches .swatch').forEach(s=>s.classList.remove('active'));el.classList.add('active');renderPreview();}
function setAccent(el){currentAccent=el.dataset.accent;document.querySelectorAll('#accentSwatches .swatch').forEach(s=>s.classList.remove('active'));el.classList.add('active');renderPreview();}
function setDevice(d,btn){document.getElementById('previewFrame').style.maxWidth=d==='desktop'?'820px':d==='tablet'?'768px':'375px';document.querySelectorAll('.device-toggle button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
function previewPage(){window.open(`/p/${PAGE_SLUG}`,'_blank')}

function generateFullHTML(){
  let html='';pageSections.forEach(sec=>{if(sec.enabled)html+=renderHTML(sec);});return html;
}

async function savePage(publish=false){
  const s=document.getElementById('saveStatus');s.textContent='Saving...';s.style.color='#fbbf24';
  try{
    const r=await fetch('/api/funnels/save',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({id:PAGE_ID,title:document.getElementById('pageName').value||'Untitled',status:publish?'published':currentStatus,
        gjs_components:pageSections,gjs_styles:{theme:currentTheme,accent:currentAccent},
        gjs_html:generateFullHTML(),
        gjs_css:`*{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif}img{max-width:100%}a{transition:opacity 0.2s}a:hover{opacity:0.9}`
      })});
    const res=await r.json();
    if(res.success){currentStatus=res.status;s.textContent=publish?'‚úì Published!':'‚úì Saved';s.style.color='#10b981';if(publish)setTimeout(()=>{s.textContent=`Live ‚Üí /p/${res.slug}`},1500);}
    else{s.textContent='‚úó '+(res.error||'Failed');s.style.color='#ef4444';}
  }catch(e){s.textContent='‚úó Network error';s.style.color='#ef4444';}
  setTimeout(()=>{s.textContent=''},4000);
}

async function init(){
  try{
    const r=await fetch(`/api/funnels/load/${PAGE_ID}`),d=await r.json();
    document.getElementById('pageName').value=d.title||'';
    if(Array.isArray(d.gjs_components)&&d.gjs_components.length>0&&d.gjs_components[0]&&d.gjs_components[0].type)pageSections=d.gjs_components;
    if(d.gjs_styles&&typeof d.gjs_styles==='object'){currentTheme=d.gjs_styles.theme||'dark-blue';currentAccent=d.gjs_styles.accent||'#0ea5e9';}
  }catch(e){}
  if(!pageSections.length)pageSections=[
    {type:'hero',enabled:true,fields:{...DEFAULTS.hero.fields}},
    {type:'features',enabled:true,fields:{...DEFAULTS.features.fields}},
    {type:'testimonials',enabled:true,fields:{...DEFAULTS.testimonials.fields}},
    {type:'cta',enabled:true,fields:{...DEFAULTS.cta.fields}},
    {type:'footer',enabled:true,fields:{...DEFAULTS.footer.fields}}
  ];
  document.querySelectorAll('#colourSwatches .swatch').forEach(s=>s.classList.toggle('active',s.dataset.theme===currentTheme));
  document.querySelectorAll('#accentSwatches .swatch').forEach(s=>s.classList.toggle('active',s.dataset.accent===currentAccent));
  renderAll();
}
setInterval(()=>savePage(),60000);
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();savePage();}});
init();
</script>
</body>
</html>
