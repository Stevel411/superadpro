<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch & Earn ‚Äî SuperAdPro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rethink+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Rethink Sans',sans-serif;background:#f0f2f8;color:#0f172a;min-height:100vh;display:flex}

/* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
.sidebar{width:224px;min-height:100vh;background:#0a0a1a;border-right:1px solid rgba(0,180,216,0.08);position:fixed;top:0;left:0;z-index:100;display:flex;flex-direction:column}
.sidebar-brand{font-weight:800;font-size:14px;letter-spacing:2px;text-transform:uppercase;background:linear-gradient(135deg,#00d4ff,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.sidebar-logo{display:flex;align-items:center;gap:10px;padding:20px 18px 16px}
.logo-shield{width:32px;height:32px}
.nav-section{padding:18px 16px 5px;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(200,220,255,0.25)}
.nav-item{display:flex;align-items:center;gap:11px;padding:12px 18px;font-size:17px;font-weight:600;color:rgba(200,220,255,0.6);text-decoration:none;transition:all 0.15s;border-left:2px solid transparent}
.nav-item:hover{color:rgba(200,220,255,0.9);background:rgba(255,255,255,0.03)}
.nav-item.active{color:#00d4ff;background:rgba(0,212,255,0.07);border-left-color:#00d4ff}
.nav-icon{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.sidebar-footer{margin-top:auto;padding:16px;border-top:1px solid rgba(0,180,216,0.08)}
.user-mini{display:flex;align-items:center;gap:10px}
.user-mini-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#00b4d8,#6d28d9);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;flex-shrink:0}

/* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
.main{margin-left:224px;flex:1;display:flex;flex-direction:column;height:100vh;overflow:hidden}
.topbar{background:#0a0a1a;border-bottom:1px solid rgba(0,180,216,0.08);padding:0 28px;height:58px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;flex-shrink:0}
.topbar-title{font-size:22px;font-weight:800;color:#ffffff}
.topbar-sub{font-size:13px;color:#94a3b8;margin-top:1px}
.content{padding:20px 24px;flex:1;overflow-y:auto}
.watch-container{max-width:900px;margin:0 auto;display:flex;flex-direction:column;gap:16px}

/* ‚îÄ‚îÄ Quota bar ‚îÄ‚îÄ */
.quota-bar-wrap{background:#ffffff;border:1px solid #e2e8f0;border-radius:12px;padding:14px 20px;flex-shrink:0;display:flex;align-items:center;gap:20px;flex-wrap:wrap;box-shadow:0 1px 3px rgba(0,0,0,0.05);width:100%}
.quota-label{font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#64748b;margin-bottom:5px}
.quota-count{font-size:28px;font-weight:800;color:#00d4ff}
.quota-track{flex:1;min-width:200px}
.quota-progress{height:10px;background:#e8ecf4;border-radius:999px;overflow:hidden;margin-top:8px}
.quota-fill{height:100%;background:linear-gradient(90deg,#00b4d8,#7c3aed);border-radius:999px;transition:width 0.5s ease}
.quota-complete{background:linear-gradient(90deg,#16a34a,#22c55e) !important}
.quota-dots{display:flex;gap:8px;margin-top:10px}
.quota-dot{width:28px;height:28px;border-radius:50%;border:2px solid #e2e8f0;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all 0.3s;color:#94a3b8}
.quota-dot.done{background:linear-gradient(135deg,#16a34a,#22c55e);border-color:#16a34a;color:#fff}
.quota-dot.current{border-color:#00d4ff;background:rgba(0,180,216,0.1);color:#00d4ff}
.quota-dot.pending{color:#cbd5e1;border-color:#e2e8f0}

/* ‚îÄ‚îÄ Warning banner ‚îÄ‚îÄ */
.warning-banner{border-radius:12px;padding:16px 20px;margin-bottom:0;display:flex;align-items:center;gap:12px;font-size:15px;font-weight:600}
.warning-amber{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:#fbbf24}
.warning-red{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171}

/* ‚îÄ‚îÄ Video player card ‚îÄ‚îÄ */
.player-card{background:#ffffff;border:1px solid #e2e8f0;border-radius:14px;overflow:hidden;width:100%;display:flex;flex-direction:column;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.player-header{padding:12px 20px;border-bottom:1px solid #f1f5f9;flex-shrink:0}
.campaign-title{font-size:16px;font-weight:800;color:#0f172a;margin-bottom:2px}
.campaign-meta{font-size:13px;color:#64748b}
.video-wrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;overflow:hidden;border-radius:0}
.video-wrap iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none;display:block}

/* ‚îÄ‚îÄ Timer (below video in footer) ‚îÄ‚îÄ */
.timer-circle{width:56px;height:56px;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.timer-svg{position:absolute;top:0;left:0;transform:rotate(-90deg)}
.timer-bg{fill:none;stroke:#e2e8f0;stroke-width:5}
.timer-arc{fill:none;stroke:url(#timerGrad);stroke-width:5;stroke-linecap:round;stroke-dasharray:150.8;stroke-dashoffset:150.8;transition:stroke-dashoffset 1s linear}
.timer-num{font-size:18px;font-weight:800;color:#0f172a;z-index:1}

/* ‚îÄ‚îÄ Player footer ‚îÄ‚îÄ */
.player-footer{padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;background:#f8fafc;border-top:1px solid #e8ecf4}
/* ‚îÄ‚îÄ Unmute overlay ‚îÄ‚îÄ */
.unmute-overlay{position:absolute;top:12px;right:12px;z-index:20;background:rgba(5,13,26,0.75);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:8px 14px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:all 0.2s;backdrop-filter:blur(4px)}
.unmute-overlay:hover{background:rgba(0,180,216,0.8);border-color:rgba(0,180,216,0.5)}
.unmute-overlay.hidden{display:none}
.unmute-icon{font-size:16px}
.unmute-text{font-size:13px;font-weight:700;color:#ffffff;letter-spacing:0.3px}
.watch-status{font-size:14px;color:#64748b}
.watch-status.counting{color:#00d4ff;font-weight:700}
.watch-status.complete{color:#22c55e;font-weight:700}
.btn-next{font-size:15px;font-weight:700;color:#fff;background:linear-gradient(135deg,#00b4d8,#6d28d9);border:none;border-radius:8px;padding:12px 28px;cursor:pointer;opacity:0.4;pointer-events:none;transition:all 0.3s}
.btn-next.ready{opacity:1;pointer-events:all;box-shadow:0 4px 14px rgba(0,180,216,0.3)}
.btn-next.ready:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,180,216,0.4)}

/* ‚îÄ‚îÄ Quota complete card ‚îÄ‚îÄ */
.complete-card{background:#ffffff;border:1px solid #bbf7d0;border-radius:16px;padding:48px 32px;text-align:center;max-width:560px;margin:0 auto;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.complete-icon{font-size:56px;margin-bottom:16px}
.complete-title{font-size:24px;font-weight:800;color:#4ade80;margin-bottom:10px}
.complete-sub{font-size:15px;color:#475569;line-height:1.7;margin-bottom:28px}
.complete-stats{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:28px}
.complete-stat{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:14px 20px;min-width:120px}
.complete-stat-val{font-size:22px;font-weight:800;color:#4ade80}
.complete-stat-lbl{font-size:11px;color:#64748b;margin-top:2px;text-transform:uppercase;letter-spacing:1px}
.btn-dashboard{display:inline-block;font-size:15px;font-weight:700;color:#fff;background:linear-gradient(135deg,#00b4d8,#6d28d9);border-radius:8px;padding:13px 32px;text-decoration:none;box-shadow:0 4px 14px rgba(0,180,216,0.3)}

/* ‚îÄ‚îÄ No campaigns ‚îÄ‚îÄ */
.empty-card{background:#ffffff;border:1px solid #e2e8f0;border-radius:16px;padding:48px 32px;text-align:center;max-width:500px;margin:0 auto;box-shadow:0 1px 4px rgba(0,0,0,0.06)}

/* ‚îÄ‚îÄ Terms note ‚îÄ‚îÄ */
.terms-note{flex-shrink:0;font-size:12px;color:#94a3b8;text-align:center;line-height:1.5}

/* ‚îÄ‚îÄ Mobile topbar ‚îÄ‚îÄ */
.mobile-topbar{display:none;align-items:center;justify-content:space-between;padding:10px 16px;background:#0a0a1a;border-bottom:1px solid rgba(0,212,255,0.1);position:sticky;top:0;z-index:101}
.mobile-topbar-left{display:flex;align-items:center;gap:10px;text-decoration:none}
.mobile-topbar-name{font-weight:800;font-size:12px;letter-spacing:2px;text-transform:uppercase;background:linear-gradient(135deg,#00d4ff,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.mobile-topbar-page{font-size:11px;color:#64748b}
.mobile-balance-chip{font-size:13px;font-weight:800;color:#16a34a;background:rgba(22,163,74,0.08);border:1px solid rgba(22,163,74,0.2);border-radius:8px;padding:6px 12px}

/* ‚îÄ‚îÄ Mobile bottom nav ‚îÄ‚îÄ */
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#0a0a1a;border-top:1px solid rgba(0,212,255,0.1);z-index:100;padding:6px 0 env(safe-area-inset-bottom,6px)}
.mobile-nav-inner{display:flex;justify-content:space-around;align-items:center}
.mob-nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;text-decoration:none;padding:6px 8px;font-size:10px;color:#64748b;transition:color 0.15s}
.mob-nav-item.active{color:#00d4ff}
.mob-nav-icon{font-size:18px}
.mob-nav-label{font-weight:600;letter-spacing:0.3px}

@media(max-width:768px){
  .sidebar{display:none}
  .main{margin-left:0;height:auto;overflow:visible}
  .mobile-topbar{display:flex!important}
  .mobile-nav{display:block}
  body{padding-bottom:70px}
  .topbar{display:none}
  .content{padding:12px}
  .watch-container{gap:12px}
  .quota-bar-wrap{padding:12px 14px;gap:12px;flex-direction:column;align-items:stretch}
  .quota-count{font-size:22px}
  .quota-track{min-width:0}
  .quota-dots{flex-wrap:wrap}
  .video-wrap{aspect-ratio:16/9}
  .player-footer{padding:12px 14px;gap:10px;flex-direction:column;align-items:stretch}
  .timer-circle{align-self:center}
  .watch-status{text-align:center}
  .btn-next{width:100%;text-align:center;padding:14px;font-size:16px}
  .player-header{padding:10px 14px}
  .campaign-title{font-size:14px}
  .complete-card{padding:32px 20px}
  .complete-title{font-size:20px}
  .complete-stats{gap:10px}
  .complete-stat{min-width:100px;padding:12px 14px}
  .terms-note{padding:0 8px}
}
</style>
  <link rel="stylesheet" href="/static/mobile.css">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#0a0a1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SuperAdPro">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
</head>
<body>
<!-- ‚îÄ‚îÄ Mobile Topbar ‚îÄ‚îÄ -->
<div class="mobile-topbar">
  <a class="mobile-topbar-left" href="/dashboard">
    <svg width="26" height="26" viewBox="0 0 100 100">
      <defs>
        <linearGradient id="mhg" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#4f8ef7"/>
          <stop offset="50%" stop-color="#6d28d9"/>
          <stop offset="100%" stop-color="#00b4d8"/>
        </linearGradient>
      </defs>
      <polygon points="50,3 93,27 93,73 50,97 7,73 7,27" fill="url(#mhg)"/>
      <text x="50" y="63" text-anchor="middle" font-family="Arial Black" font-weight="900" font-size="42" fill="#00d4ff">S</text>
    </svg>
    <div>
      <div class="mobile-topbar-name">SuperAdPro</div>
      <div class="mobile-topbar-page">Watch & Earn</div>
    </div>
  </a>
  <div class="mobile-balance-chip">${{ '%.2f'|format(balance) }} USDT</div>
</div>


<!-- Sidebar -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <svg class="logo-shield" viewBox="0 0 40 46" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M20 2L4 9V22C4 31.4 11.1 40.2 20 43C28.9 40.2 36 31.4 36 22V9L20 2Z" fill="url(#sg)" stroke="rgba(0,212,255,0.3)" stroke-width="1"/>
      <path d="M14 22L18 26L26 18" stroke="#00d4ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <defs><linearGradient id="sg" x1="4" y1="2" x2="36" y2="43" gradientUnits="userSpaceOnUse"><stop stop-color="#0a0a2a"/><stop offset="1" stop-color="#1a1a4a"/></linearGradient></defs>
    </svg>
    <span class="sidebar-brand">SuperAdPro</span>
  </div>

  <div class="nav-section">Main</div>
  <a href="/dashboard"    class="nav-item"><span class="nav-icon">‚äû</span>Dashboard</a>
  <a href="/watch"        class="nav-item active"><span class="nav-icon">‚ñ∂</span>Watch & Earn</a>
  <a href="/packages"     class="nav-item"><span class="nav-icon">üì¶</span>Campaign Tiers</a>
  <a href="/video-library" class="nav-item"><span class="nav-icon">üé¨</span>My Campaigns</a>

    <div class="nav-section">Marketing Suite</div>
    <a href="/campaign-studio" class="nav-item"><span class="nav-icon">ü§ñ</span>AI Campaign Studio</a>
    <a href="/niche-finder"    class="nav-item"><span class="nav-icon">üí°</span>Niche Finder</a>
    <a href="/swipe-file"      class="nav-item"><span class="nav-icon">üìã</span>Swipe File</a>

  <div class="nav-section">Income Streams</div>
  <a href="/income-grid"  class="nav-item"><span class="nav-icon">‚óà</span>Profit Engine Grid</a>
  <a href="/wallet"       class="nav-item"><span class="nav-icon">‚óé</span>Wallet</a>
  <a href="/affiliate"    class="nav-item"><span class="nav-icon">‚¨°</span>Affiliate Tools</a>
  <a href="/compensation-plan" class="nav-item"><span class="nav-icon">üìä</span>Comp Plan</a>
  <a href="/grid-visualiser"   class="nav-item"><span class="nav-icon">‚óâ</span>Grid Visualiser</a>

  <div class="nav-section">Account</div>
  <a href="/account"      class="nav-item"><span class="nav-icon">‚óØ</span>Profile</a>
  <a href="/support"      class="nav-item"><span class="nav-icon">‚óØ</span>Support</a>

  <div class="sidebar-footer">
    <div class="user-mini">
      <div class="user-mini-avatar">{{ (user.first_name or user.username)[0]|upper }}</div>
      <div>
        <div style="font-size:15px;font-weight:700;color:#fff">{{ user.first_name or user.username }}</div>
        <div style="font-size:11px;color:{% if user.is_active %}#10b981{% else %}#f59e0b{% endif %};letter-spacing:1px;text-transform:uppercase;margin-top:1px">
          {% if user.is_active %}‚óè Active{% else %}‚óã Inactive{% endif %}
        </div>
      </div>
    </div>
    <a href="/logout" style="display:block;margin-top:12px;font-size:14px;color:#94a3b8;text-decoration:none">‚èª Sign Out</a>
  </div>
</nav>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <div>
      <div class="topbar-title">‚ñ∂ Watch & Earn</div>
      <div class="topbar-sub">Watch videos ¬∑ Qualify for daily commissions</div>
    </div>
    <div style="font-size:13px;color:#94a3b8;text-align:right">
      <div style="color:#00d4ff;font-weight:700;font-size:16px">Tier {{ quota.package_tier }}</div>
      <div>{{ quota.daily_required }} video{{ 's' if quota.daily_required != 1 else '' }} required today</div>
    </div>
  </div>

  <div class="content">
  <div class="watch-container">

    <!-- Warning banner -->
    {% if warning %}
    <div class="warning-banner {% if quota.commissions_paused %}warning-red{% else %}warning-amber{% endif %}">
      <span style="font-size:20px">{% if quota.commissions_paused %}üî¥{% else %}‚ö†Ô∏è{% endif %}</span>
      <span>{{ warning }}</span>
    </div>
    {% endif %}

    <!-- Quota progress -->
    <div class="quota-bar-wrap">
      <div>
        <div class="quota-label">Today's Progress</div>
        <div class="quota-count" id="watchedCount">{{ quota.today_watched }}</div>
        <div style="font-size:13px;color:#94a3b8;margin-top:2px">of {{ quota.daily_required }} video{{ 's' if quota.daily_required != 1 else '' }}</div>
      </div>
      <div class="quota-track">
        <div style="display:flex;justify-content:space-between;font-size:13px;color:#94a3b8;margin-bottom:6px">
          <span>Daily Quota</span>
          <span id="pctLabel">{{ ((quota.today_watched / quota.daily_required) * 100)|int }}%</span>
        </div>
        <div class="quota-progress">
          <div class="quota-fill {% if quota.today_watched >= quota.daily_required %}quota-complete{% endif %}"
               id="quotaFill"
               style="width:{{ [(quota.today_watched / quota.daily_required * 100), 100]|min }}%"></div>
        </div>
        <!-- Dot indicators -->
        <div class="quota-dots" id="quotaDots">
          {% for i in range(quota.daily_required) %}
          <div class="quota-dot {% if i < quota.today_watched %}done{% elif i == quota.today_watched %}current{% else %}pending{% endif %}" id="dot-{{ i }}">
            {% if i < quota.today_watched %}‚úì{% else %}{{ i + 1 }}{% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% if quota.consecutive_missed > 0 and not quota.commissions_paused %}
      <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px 16px;font-size:13px;text-align:center">
        <div style="color:#d97706;font-weight:700;font-size:16px">{{ grace_days - quota.consecutive_missed }}</div>
        <div style="color:#78350f;margin-top:2px">grace days left</div>
      </div>
      {% endif %}
    </div>

    <!-- Quota already complete -->
    {% if quota.today_watched >= quota.daily_required %}
    <div class="complete-card">
      <div class="complete-icon">üéâ</div>
      <div class="complete-title">Today's Quota Complete!</div>
      <div class="complete-sub">
        You've watched all {{ quota.daily_required }} required video{{ 's' if quota.daily_required != 1 else '' }} today.
        Your commissions are fully qualified for today. Come back tomorrow for your next session.
      </div>
      <div class="complete-stats">
        <div class="complete-stat">
          <div class="complete-stat-val">{{ quota.today_watched }}</div>
          <div class="complete-stat-lbl">Videos Today</div>
        </div>
        <div class="complete-stat">
          <div class="complete-stat-val">{{ quota.daily_required * 30 }}s</div>
          <div class="complete-stat-lbl">Time Watched</div>
        </div>
        <div class="complete-stat">
          <div class="complete-stat-val">Tier {{ quota.package_tier }}</div>
          <div class="complete-stat-lbl">Your Level</div>
        </div>
      </div>
      <a href="/dashboard" class="btn-dashboard">Back to Dashboard ‚Üí</a>
    </div>

    <!-- No campaigns available -->
    {% elif not campaign %}
    <div class="empty-card">
      <div style="font-size:48px;margin-bottom:16px">üì≠</div>
      <div style="font-size:18px;font-weight:800;color:#0f172a;margin-bottom:8px">No Active Campaigns Yet</div>
      <div style="font-size:14px;color:#475569;line-height:1.7;margin-bottom:20px">
        There are no active video campaigns in the pool right now. Check back soon ‚Äî campaigns are added as advertisers activate their campaign tiers.
      </div>
      <a href="/dashboard" style="font-size:14px;font-weight:700;color:#00d4ff;text-decoration:none">‚Üê Back to Dashboard</a>
    </div>

    <!-- Video player -->
    {% else %}
    <div class="player-card" id="playerCard">
      <div class="player-header">
        <div class="campaign-title" id="campaignTitle">{{ campaign.title }}</div>
        <div class="campaign-meta" id="campaignMeta">
          {{ campaign.platform|title }} ¬∑ {{ campaign.category or 'General' }} ¬∑ 
          Campaign #{{ campaign.id }}
        </div>
      </div>

      <!-- SVG gradient for timer arc -->
      <svg width="0" height="0" style="position:absolute">
        <defs>
          <linearGradient id="timerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#00b4d8"/>
            <stop offset="100%" stop-color="#7c3aed"/>
          </linearGradient>
        </defs>
      </svg>

      <div class="video-wrap">
        <iframe id="videoFrame"
          src="{{ campaign.embed_url }}{% if '?' in campaign.embed_url %}&{% else %}?{% endif %}autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&showinfo=0&iv_load_policy=3&playsinline=1"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
        <!-- Unmute prompt ‚Äî top right corner of video -->
        <div class="unmute-overlay" id="unmuteOverlay" onclick="unmuteVideo()">
          <span class="unmute-icon">üîá</span>
          <span class="unmute-text">Click to unmute</span>
        </div>
      </div>

      <!-- Timer bar ‚Äî below the video, not overlaid -->
      <div class="player-footer">
        <div style="display:flex;align-items:center;gap:14px">
          <div class="timer-circle">
            <svg class="timer-svg" width="56" height="56" viewBox="0 0 56 56">
              <circle class="timer-bg" cx="28" cy="28" r="24"/>
              <circle class="timer-arc" id="timerArc" cx="28" cy="28" r="24"/>
            </svg>
            <div class="timer-num" id="timerNum">{{ watch_duration }}</div>
          </div>
          <div>
            <div class="watch-status counting" id="watchStatus">‚è± Watching ‚Äî timer counting down</div>
            <div style="font-size:12px;color:#94a3b8;margin-top:2px">Must watch {{ watch_duration }}s to qualify</div>
          </div>
        </div>
        <button class="btn-next" id="btnNext" onclick="submitWatch()">
          ‚úì Mark as Watched ‚Üí
        </button>
      </div>
    </div>

    <div class="terms-note">
      Videos must be watched for a minimum of {{ watch_duration }} seconds to qualify.
      Complete {{ quota.daily_required }} video{{ 's' if quota.daily_required != 1 else '' }} per day to maintain your commission eligibility.
      You have a {{ grace_days }}-day grace period before commissions are paused.
      <a href="/legal" style="color:#00d4ff;text-decoration:none">Full terms ‚Üí</a>
    </div>
    {% endif %}

  </div><!-- /watch-container -->
  </div>
</div>

<script>
(function() {
  const DURATION    = {{ watch_duration }};
  const CAMPAIGN_ID = {{ campaign.id if campaign else 0 }};
  const QUOTA_MET   = {{ 'true' if quota.today_watched >= quota.daily_required else 'false' }};

  if (QUOTA_MET || !CAMPAIGN_ID) return;

  const timerArc    = document.getElementById('timerArc');
  const timerNum    = document.getElementById('timerNum');
  const watchStatus = document.getElementById('watchStatus');
  const btnNext     = document.getElementById('btnNext');
  const quotaFill   = document.getElementById('quotaFill');
  const watchedCount= document.getElementById('watchedCount');
  const pctLabel    = document.getElementById('pctLabel');

  const circumference = 2 * Math.PI * 24; // r=24 ‚Üí 150.8
  let secondsLeft = DURATION;
  let timerDone   = false;
  let submitted   = false;

  // Start timer immediately ‚Äî video plays freely, timer counts alongside
  const interval = setInterval(() => {
    secondsLeft--;
    timerNum.textContent = secondsLeft;

    // Update arc progress
    const progress = (DURATION - secondsLeft) / DURATION;
    timerArc.style.strokeDashoffset = circumference * (1 - progress);

    if (secondsLeft <= 0) {
      clearInterval(interval);
      timerDone = true;
      timerArc.style.strokeDashoffset = 0;
      watchStatus.textContent = '‚úÖ Qualified ‚Äî click to record your view';
      watchStatus.className   = 'watch-status complete';
      btnNext.classList.add('ready');
    }
  }, 1000);

  window.unmuteVideo = function() {
    // Reload iframe src without mute=1 ‚Äî browser allows this after user gesture
    const frame = document.getElementById('videoFrame');
    const overlay = document.getElementById('unmuteOverlay');
    frame.src = frame.src
      .replace('&mute=1', '')
      .replace('mute=1&', '')
      .replace('?mute=1', '?');
    overlay.classList.add('hidden');
  };

  window.submitWatch = async function() {
    if (!timerDone || submitted) return;
    submitted = true;
    btnNext.disabled    = true;
    btnNext.textContent = 'Recording...';

    try {
      const form = new FormData();
      form.append('campaign_id', CAMPAIGN_ID);

      const res  = await fetch('/api/record-watch', { method: 'POST', body: form });
      const data = await res.json();

      if (data.success) {
        if (data.quota_met) {
          // Quota complete ‚Äî reload to show completion screen
          window.location.reload();
        } else if (data.next_campaign) {
          // Load next video without full page reload
          loadNextVideo(data.next_campaign, data.watched_today, data.required);
        } else {
          window.location.reload();
        }
      } else {
        if (data.quota_met) {
          window.location.reload();
        } else {
          btnNext.textContent = 'Error ‚Äî try again';
          btnNext.disabled    = false;
          submitted = false;
        }
      }
    } catch(e) {
      btnNext.textContent = 'Error ‚Äî try again';
      btnNext.disabled    = false;
      submitted = false;
    }
  };

  function loadNextVideo(campaign, watchedToday, required) {
    // Update quota display
    const pct = Math.min((watchedToday / required) * 100, 100);
    quotaFill.style.width   = pct + '%';
    watchedCount.textContent = watchedToday;
    pctLabel.textContent    = Math.round(pct) + '%';

    // Update dot indicators
    for (let i = 0; i < required; i++) {
      const dot = document.getElementById('dot-' + i);
      if (!dot) continue;
      if (i < watchedToday) {
        dot.className   = 'quota-dot done';
        dot.textContent = '‚úì';
      } else if (i === watchedToday) {
        dot.className   = 'quota-dot current';
        dot.textContent = i + 1;
      }
    }

    // Swap video
    document.getElementById('campaignTitle').textContent = campaign.title;
    document.getElementById('campaignMeta').textContent  =
      campaign.platform.charAt(0).toUpperCase() + campaign.platform.slice(1) +
      ' ¬∑ Campaign #' + campaign.id;
    const sep = campaign.embed_url.includes('?') ? '&' : '?';
    document.getElementById('videoFrame').src = campaign.embed_url + sep + 'autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&showinfo=0&iv_load_policy=3&playsinline=1';
    // Show unmute overlay again for new video
    const uo = document.getElementById('unmuteOverlay');
    if (uo) uo.classList.remove('hidden');

    // Reset timer for next video
    secondsLeft = DURATION;
    timerDone   = false;
    submitted   = false;
    timerArc.style.strokeDashoffset = circumference;
    timerNum.textContent            = DURATION;
    watchStatus.textContent = '‚è± Watching ‚Äî timer counting down';
    watchStatus.className   = 'watch-status counting';
    btnNext.classList.remove('ready');
    btnNext.textContent = '‚úì Mark as Watched ‚Üí';
    btnNext.disabled    = false;

    // Restart timer
    const newInterval = setInterval(() => {
      secondsLeft--;
      timerNum.textContent = secondsLeft;
      const progress = (DURATION - secondsLeft) / DURATION;
      timerArc.style.strokeDashoffset = circumference * (1 - progress);
      if (secondsLeft <= 0) {
        clearInterval(newInterval);
        timerDone = true;
        timerArc.style.strokeDashoffset = 0;
        watchStatus.textContent = '‚úÖ Qualified ‚Äî click to record your view';
        watchStatus.className   = 'watch-status complete';
        btnNext.classList.add('ready');
      }
    }, 1000);
  }
})();
</script>

<!-- ‚îÄ‚îÄ Mobile Bottom Nav ‚îÄ‚îÄ -->
<div class="mobile-nav">
  <div class="mobile-nav-inner">
    <a href="/dashboard" class="mob-nav-item"><span class="mob-nav-icon">‚äû</span><span class="mob-nav-label">Home</span></a>
    <a href="/watch" class="mob-nav-item active"><span class="mob-nav-icon">‚ñ∂</span><span class="mob-nav-label">Watch</span></a>
    <a href="/income-grid" class="mob-nav-item"><span class="mob-nav-icon">‚ö°</span><span class="mob-nav-label">Grid</span></a>
    <a href="/wallet" class="mob-nav-item"><span class="mob-nav-icon">‚óé</span><span class="mob-nav-label">Wallet</span></a>
    <a href="/account" class="mob-nav-item"><span class="mob-nav-icon">‚óâ</span><span class="mob-nav-label">Account</span></a>
  </div>
</div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/static/sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
