<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>{{ 'Edit' if page else 'New' }} Page ‚Äî Funnel Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Rethink+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Rethink Sans',sans-serif;background:#f0f2f8;color:#0f172a;min-height:100vh}
.layout{display:flex;min-height:100vh}
.sidebar{width:224px;min-height:100vh;background:#0a0a1a;border-right:1px solid rgba(0,212,255,0.08);position:fixed;top:0;left:0;z-index:100;display:flex;flex-direction:column}
.sidebar-logo{display:flex;align-items:center;gap:10px;padding:20px 18px;border-bottom:1px solid rgba(255,255,255,0.06);text-decoration:none}
.sidebar-brand{font-weight:800;font-size:12px;letter-spacing:2px;text-transform:uppercase;background:linear-gradient(135deg,#00d4ff,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nav-section{padding:18px 16px 5px;font-size:9px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#00d4ff}
.nav-item{display:flex;align-items:center;gap:11px;padding:12px 18px;font-size:15px;font-weight:500;color:#64748b;text-decoration:none;border-left:2px solid transparent;transition:all 0.2s}
.nav-item:hover{color:rgba(200,220,255,0.9);background:rgba(255,255,255,0.03)}
.nav-item.active{color:#00d4ff;background:rgba(0,212,255,0.07);border-left-color:#00d4ff}
.nav-icon{font-size:12px;width:18px;text-align:center;flex-shrink:0}
.sidebar-footer{margin-top:auto;padding:14px 12px;border-top:1px solid rgba(255,255,255,0.06)}
.user-mini{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.1);border-radius:8px}
.user-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#6d28d9,#00d4ff);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:#fff;flex-shrink:0}
.main{margin-left:224px;flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:80px;background:#0a0a1a;border-bottom:1px solid rgba(0,212,255,0.1);position:sticky;top:0;z-index:50}
.topbar-title{font-size:22px;font-weight:800;color:#fff}
.topbar-sub{font-size:12px;color:rgba(0,212,255,0.5);margin-top:2px}
.topbar-right{display:flex;align-items:center;gap:10px}
.btn{padding:9px 20px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all 0.2s;font-family:inherit;text-decoration:none}
.btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.2);color:#fff}
.btn-outline:hover{background:rgba(255,255,255,0.06)}
.btn-save{background:linear-gradient(135deg,#16a34a,#15803d);color:#fff}
.btn-save:hover{transform:translateY(-1px)}
.btn-publish{background:linear-gradient(135deg,#00b4d8,#6d28d9);color:#fff}
.btn-publish:hover{transform:translateY(-1px)}

.content{padding:24px 28px;flex:1}
.editor-grid{display:grid;grid-template-columns:380px 1fr;gap:24px;align-items:start}

/* ‚îÄ‚îÄ LEFT: Form Panel ‚îÄ‚îÄ */
.form-panel{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:24px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.form-section{margin-bottom:20px}
.form-section-title{font-size:13px;font-weight:800;color:#0f172a;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.form-label{display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:4px}
.form-input,.form-textarea,.form-select{width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;font-family:inherit;background:#fff;color:#0f172a;transition:border-color 0.2s}
.form-input:focus,.form-textarea:focus,.form-select:focus{outline:none;border-color:#00b4d8}
.form-textarea{resize:vertical;min-height:80px}
.form-row{margin-bottom:12px}

/* Template picker */
.template-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.template-opt{padding:10px 6px;border:2px solid #e2e8f0;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s;font-size:11px;font-weight:600}
.template-opt:hover{border-color:#94a3b8}
.template-opt.selected{border-color:#00b4d8;background:rgba(0,180,216,0.06)}
.template-opt .t-icon{font-size:20px;display:block;margin-bottom:3px}

/* Color picker */
.color-grid{display:flex;gap:8px;flex-wrap:wrap}
.color-opt{width:36px;height:36px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.2s;position:relative}
.color-opt:hover{transform:scale(1.1)}
.color-opt.selected{border-color:#0f172a;box-shadow:0 0 0 2px #fff,0 0 0 4px #0f172a}
.color-opt.dark{background:#0a0a1a}
.color-opt.light{background:#f0f2f8}
.color-opt.gradient{background:linear-gradient(135deg,#0a0a1a,#1a1a4a)}
.color-opt.ocean{background:linear-gradient(135deg,#0a1628,#0a2840)}
.color-opt.fire{background:linear-gradient(135deg,#1a0a0a,#2a1a0a)}

/* Accent color */
.accent-grid{display:flex;gap:6px;flex-wrap:wrap}
.accent-opt{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.accent-opt:hover{transform:scale(1.15)}
.accent-opt.selected{border-color:#0f172a;box-shadow:0 0 0 2px #fff,0 0 0 4px #0f172a}

/* AI Generate */
.ai-section{background:linear-gradient(135deg,#f0f9ff,#faf5ff);border:1px solid #e0e7ff;border-radius:10px;padding:16px;margin-bottom:16px}
.ai-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border:none;border-radius:6px;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;font-family:inherit;width:100%}
.ai-btn:hover{transform:translateY(-1px)}
.ai-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}

/* ‚îÄ‚îÄ RIGHT: Preview Panel ‚îÄ‚îÄ */
.preview-panel{background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.06);position:sticky;top:104px}
.preview-header{padding:12px 16px;background:#f8fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between}
.preview-header-title{font-size:12px;font-weight:700;color:#64748b;letter-spacing:1px;text-transform:uppercase}
.preview-frame{min-height:500px;overflow:auto}

/* ‚îÄ‚îÄ Save notification ‚îÄ‚îÄ */
.save-toast{position:fixed;bottom:24px;right:24px;background:#16a34a;color:#fff;padding:12px 20px;border-radius:8px;font-weight:700;font-size:14px;opacity:0;transform:translateY(10px);transition:all 0.3s;z-index:200;pointer-events:none}
.save-toast.show{opacity:1;transform:translateY(0)}

@media(max-width:1100px){.editor-grid{grid-template-columns:1fr}.preview-panel{position:static}}
@media(max-width:900px){.sidebar{display:none}.main{margin-left:0}.topbar{padding:0 16px}.content{padding:16px}}
</style>
</head>
<body>
<svg style="display:none"><symbol id="shield" viewBox="0 0 30 30"><path d="M15 2L3 7v7c0 7.73 5.12 14.95 12 17 6.88-2.05 12-9.27 12-17V7L15 2z" fill="url(#sg)"/><defs><linearGradient id="sg" x1="0" y1="0" x2="30" y2="30"><stop offset="0%" stop-color="#00d4ff"/><stop offset="100%" stop-color="#7c3aed"/></linearGradient></defs></symbol></svg>

<div class="layout">
  <aside class="sidebar">
    <a href="/dashboard" class="sidebar-logo"><svg width="30" height="30"><use href="#shield"/></svg><span class="sidebar-brand">SuperAdPro</span></a>
    <div class="nav-section">Main</div>
    <a href="/dashboard" class="nav-item"><span class="nav-icon">‚äû</span>Dashboard</a>
    <a href="/packages" class="nav-item"><span class="nav-icon">üì¶</span>Campaign Tiers</a>
    <a href="/watch" class="nav-item"><span class="nav-icon">‚ñ∂</span>Watch &amp; Earn</a>
    <a href="/video-library" class="nav-item"><span class="nav-icon">üé¨</span>My Campaigns</a>
    <a href="/analytics" class="nav-item"><span class="nav-icon">üìà</span>Analytics</a>
    <div class="nav-section">Marketing Suite</div>
    <a href="/campaign-studio" class="nav-item"><span class="nav-icon">ü§ñ</span>AI Campaign Studio</a>
    <a href="/funnels" class="nav-item active"><span class="nav-icon">üöÄ</span>Funnel Builder</a>
    <a href="/niche-finder" class="nav-item"><span class="nav-icon">üí°</span>Niche Finder</a>
    <a href="/swipe-file" class="nav-item"><span class="nav-icon">üìã</span>Swipe File</a>
    <div class="nav-section">Income Streams</div>
    <a href="/income-grid" class="nav-item"><span class="nav-icon">‚ö°</span>Profit Engine Grid</a>
    <a href="/wallet" class="nav-item"><span class="nav-icon">‚óé</span>Wallet</a>
    <a href="/affiliate" class="nav-item"><span class="nav-icon">ü§ù</span>Affiliate Tools</a>
    <a href="/compensation-plan" class="nav-item"><span class="nav-icon">üìä</span>Comp Plan</a>
    <a href="/grid-visualiser" class="nav-item"><span class="nav-icon">‚óà</span>Grid Visualiser</a>
    <div class="nav-section">Account</div>
    <a href="/account" class="nav-item"><span class="nav-icon">‚óâ</span>My Profile</a>
    <a href="/support" class="nav-item"><span class="nav-icon">‚óå</span>Support</a>
    <div class="sidebar-footer">
      <div class="user-mini">
        <div class="user-avatar">{{ user.username[:2].upper() }}</div>
        <div>
          <div style="font-size:12px;font-weight:700;color:#fff">{{ user.first_name or user.username }}</div>
          <div style="font-size:9px;color:{% if is_active %}#10b981{% else %}#f59e0b{% endif %};letter-spacing:1px;text-transform:uppercase;margin-top:1px">{% if is_active %}‚óè Active{% else %}‚óã Inactive{% endif %}</div>
        </div>
      </div>
      <a href="/logout" style="display:flex;align-items:center;gap:8px;padding:9px 12px;font-size:12px;color:#64748b;text-decoration:none;margin-top:4px;border-radius:6px">‚éã Sign Out</a>
    </div>
  </aside>

  <div class="main">
    <div class="topbar">
      <div>
        <div class="topbar-title">{{ 'Edit Page' if page else 'Create New Page' }}</div>
        <div class="topbar-sub">{% if page %}Editing: {{ page.title }}{% else %}Choose a template and customise{% endif %}</div>
      </div>
      <div class="topbar-right">
        <a href="/funnels" class="btn btn-outline">‚Üê Back</a>
        <button class="btn btn-save" onclick="savePage('draft')">üíæ Save Draft</button>
        <button class="btn btn-publish" onclick="savePage('published')">üöÄ Publish</button>
      </div>
    </div>

    <div class="content">
      <div class="editor-grid">

        <!-- LEFT: FORM -->
        <div class="form-panel">

          <!-- Template Type -->
          <div class="form-section">
            <div class="form-section-title">üìÑ Page Type</div>
            <div class="template-grid">
              <div class="template-opt selected" data-type="opportunity" onclick="selectTemplate(this)"><span class="t-icon">üí∞</span>Opportunity</div>
              <div class="template-opt" data-type="optin" onclick="selectTemplate(this)"><span class="t-icon">üìß</span>Lead Capture</div>
              <div class="template-opt" data-type="bridge" onclick="selectTemplate(this)"><span class="t-icon">üåâ</span>Bridge Page</div>
              <div class="template-opt" data-type="webinar" onclick="selectTemplate(this)"><span class="t-icon">üé•</span>Webinar</div>
              <div class="template-opt" data-type="thankyou" onclick="selectTemplate(this)"><span class="t-icon">‚úÖ</span>Thank You</div>
            </div>
          </div>

          <!-- AI Generate -->
          <div class="ai-section">
            <div class="form-section-title" style="margin-bottom:8px">‚ú® AI Copy Generator</div>
            <div class="form-row">
              <label class="form-label">Your Niche / Industry</label>
              <input class="form-input" id="aiNiche" placeholder="e.g. Forex trading, Weight loss, Crypto">
            </div>
            <div class="form-row">
              <label class="form-label">What are you promoting?</label>
              <input class="form-input" id="aiOffer" placeholder="e.g. My affiliate link, Training course, Free guide">
            </div>
            <button class="ai-btn" id="aiGenBtn" onclick="generateCopy()">ü§ñ Generate Copy with AI</button>
          </div>

          <!-- Page Title -->
          <div class="form-section">
            <div class="form-section-title">‚úèÔ∏è Content</div>
            <div class="form-row">
              <label class="form-label">Page Title (internal name)</label>
              <input class="form-input" id="pageTitle" value="{{ page.title if page else '' }}" placeholder="My Landing Page" oninput="updatePreview()">
            </div>
            <div class="form-row">
              <label class="form-label">Headline</label>
              <input class="form-input" id="headline" value="{{ page.headline if page else '' }}" placeholder="Your Attention-Grabbing Headline" oninput="updatePreview()">
            </div>
            <div class="form-row">
              <label class="form-label">Subheadline</label>
              <input class="form-input" id="subheadline" value="{{ page.subheadline if page else '' }}" placeholder="Supporting line that builds on the headline" oninput="updatePreview()">
            </div>
            <div class="form-row">
              <label class="form-label">Body Copy / Bullet Points</label>
              <textarea class="form-textarea" id="bodyCopy" rows="5" placeholder="‚úì Benefit one&#10;‚úì Benefit two&#10;‚úì Benefit three" oninput="updatePreview()">{{ page.body_copy if page else '' }}</textarea>
            </div>
            <div class="form-row">
              <label class="form-label">Video URL (optional ‚Äî YouTube/Vimeo/Rumble)</label>
              <input class="form-input" id="videoUrl" value="{{ page.video_url if page else '' }}" placeholder="https://youtube.com/watch?v=..." oninput="updatePreview()">
            </div>
            <div class="form-row">
              <label class="form-label">CTA Button Text</label>
              <input class="form-input" id="ctaText" value="{{ page.cta_text if page else 'Get Started Now' }}" placeholder="Get Started Now" oninput="updatePreview()">
            </div>
            <div class="form-row">
              <label class="form-label">CTA Button Link</label>
              <input class="form-input" id="ctaUrl" value="{{ page.cta_url if page else '' }}" placeholder="https://your-affiliate-link.com" oninput="updatePreview()">
            </div>
          </div>

          <!-- Style -->
          <div class="form-section">
            <div class="form-section-title">üé® Style</div>
            <div class="form-row">
              <label class="form-label">Background Theme</label>
              <div class="color-grid">
                <div class="color-opt dark selected" data-scheme="dark" onclick="selectColor(this)" title="Dark"></div>
                <div class="color-opt light" data-scheme="light" onclick="selectColor(this)" title="Light"></div>
                <div class="color-opt gradient" data-scheme="gradient" onclick="selectColor(this)" title="Gradient"></div>
                <div class="color-opt ocean" data-scheme="ocean" onclick="selectColor(this)" title="Ocean"></div>
                <div class="color-opt fire" data-scheme="fire" onclick="selectColor(this)" title="Fire"></div>
              </div>
            </div>
            <div class="form-row" style="margin-top:12px">
              <label class="form-label">Accent Color</label>
              <div class="accent-grid">
                <div class="accent-opt selected" style="background:#00d4ff" data-color="#00d4ff" onclick="selectAccent(this)"></div>
                <div class="accent-opt" style="background:#7c3aed" data-color="#7c3aed" onclick="selectAccent(this)"></div>
                <div class="accent-opt" style="background:#16a34a" data-color="#16a34a" onclick="selectAccent(this)"></div>
                <div class="accent-opt" style="background:#f59e0b" data-color="#f59e0b" onclick="selectAccent(this)"></div>
                <div class="accent-opt" style="background:#ef4444" data-color="#ef4444" onclick="selectAccent(this)"></div>
                <div class="accent-opt" style="background:#ec4899" data-color="#ec4899" onclick="selectAccent(this)"></div>
                <div class="accent-opt" style="background:#f97316" data-color="#f97316" onclick="selectAccent(this)"></div>
                <div class="accent-opt" style="background:#06b6d4" data-color="#06b6d4" onclick="selectAccent(this)"></div>
              </div>
            </div>
          </div>

        </div>

        <!-- RIGHT: PREVIEW -->
        <div class="preview-panel">
          <div class="preview-header">
            <span class="preview-header-title">Live Preview</span>
            <span style="font-size:11px;color:#94a3b8">Updates as you type</span>
          </div>
          <div class="preview-frame" id="previewFrame"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="save-toast" id="saveToast"></div>

<script>
let pageId = {{ page.id if page else 'null' }};
let selectedTemplate = '{{ page.template_type if page else "opportunity" }}';
let selectedScheme = '{{ page.color_scheme if page else "dark" }}';
let selectedAccent = '{{ page.accent_color if page else "#00d4ff" }}';

// Init template selection from saved data
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.template-opt').forEach(el => {
    el.classList.toggle('selected', el.dataset.type === selectedTemplate);
  });
  document.querySelectorAll('.color-opt').forEach(el => {
    el.classList.toggle('selected', el.dataset.scheme === selectedScheme);
  });
  document.querySelectorAll('.accent-opt').forEach(el => {
    el.classList.toggle('selected', el.dataset.color === selectedAccent);
  });
  updatePreview();
});

function selectTemplate(el) {
  document.querySelectorAll('.template-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedTemplate = el.dataset.type;
  updatePreview();
}

function selectColor(el) {
  document.querySelectorAll('.color-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedScheme = el.dataset.scheme;
  updatePreview();
}

function selectAccent(el) {
  document.querySelectorAll('.accent-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedAccent = el.dataset.color;
  updatePreview();
}

function getFormData() {
  return {
    title: document.getElementById('pageTitle').value || 'My Page',
    headline: document.getElementById('headline').value,
    subheadline: document.getElementById('subheadline').value,
    body_copy: document.getElementById('bodyCopy').value,
    video_url: document.getElementById('videoUrl').value,
    cta_text: document.getElementById('ctaText').value || 'Get Started Now',
    cta_url: document.getElementById('ctaUrl').value,
    template_type: selectedTemplate,
    color_scheme: selectedScheme,
    accent_color: selectedAccent,
  };
}

function getBgStyle(scheme) {
  const bgs = {
    dark: 'background:#0a0a1a;color:#e2e8f0',
    light: 'background:#f8fafc;color:#0f172a',
    gradient: 'background:linear-gradient(160deg,#0a0a1a 0%,#1a1a4a 50%,#0a0a2a 100%);color:#e2e8f0',
    ocean: 'background:linear-gradient(160deg,#0a1628 0%,#0a2840 50%,#061420 100%);color:#e2e8f0',
    fire: 'background:linear-gradient(160deg,#1a0a0a 0%,#2a1a0a 50%,#1a0a05 100%);color:#e2e8f0',
  };
  return bgs[scheme] || bgs.dark;
}

function getTextColor(scheme) {
  return scheme === 'light' ? '#0f172a' : '#e2e8f0';
}

function getSubColor(scheme) {
  return scheme === 'light' ? '#64748b' : 'rgba(226,232,240,0.6)';
}

function buildVideoEmbed(url) {
  if(!url) return '';
  let embedUrl = '';
  // YouTube
  const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/);
  if(ytMatch) embedUrl = `https://www.youtube.com/embed/${ytMatch[1]}`;
  // Vimeo
  const vmMatch = url.match(/vimeo\.com\/(\d+)/);
  if(vmMatch) embedUrl = `https://player.vimeo.com/video/${vmMatch[1]}`;
  // Rumble
  const rbMatch = url.match(/rumble\.com\/embed\/([\w-]+)/);
  if(rbMatch) embedUrl = url;
  if(!embedUrl && url.includes('rumble.com')) embedUrl = url.replace('/v/', '/embed/');

  if(!embedUrl) return '';
  return `<div style="position:relative;width:100%;max-width:640px;margin:0 auto 28px;border-radius:12px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.3)"><div style="padding-top:56.25%"><iframe src="${embedUrl}" style="position:absolute;top:0;left:0;width:100%;height:100%;border:none" allowfullscreen></iframe></div></div>`;
}

function updatePreview() {
  const d = getFormData();
  const bg = getBgStyle(d.color_scheme);
  const textColor = getTextColor(d.color_scheme);
  const subColor = getSubColor(d.color_scheme);
  const ac = d.accent_color;

  const bullets = (d.body_copy || '').split('\n').filter(l => l.trim()).map(l =>
    `<div style="display:flex;align-items:start;gap:10px;margin-bottom:10px;font-size:15px;line-height:1.6"><span style="color:${ac};flex-shrink:0;font-size:16px">‚úì</span><span>${l.replace(/^[‚úì‚úî‚Ä¢\-]\s*/, '')}</span></div>`
  ).join('');

  const video = buildVideoEmbed(d.video_url);

  const html = `
    <div style="${bg};min-height:500px;padding:48px 32px;font-family:'Rethink Sans',sans-serif;text-align:center">
      <div style="max-width:640px;margin:0 auto">
        ${d.headline ? `<h1 style="font-size:28px;font-weight:800;line-height:1.2;margin-bottom:12px;color:${textColor}">${d.headline}</h1>` : '<h1 style="font-size:28px;font-weight:800;color:#94a3b8;margin-bottom:12px">Your Headline Here</h1>'}
        ${d.subheadline ? `<p style="font-size:16px;color:${subColor};margin-bottom:28px;line-height:1.5">${d.subheadline}</p>` : ''}
        ${video}
        ${bullets ? `<div style="text-align:left;max-width:480px;margin:0 auto 28px;color:${textColor}">${bullets}</div>` : ''}
        <a href="${d.cta_url || '#'}" style="display:inline-block;padding:16px 40px;background:${ac};color:#fff;font-size:18px;font-weight:800;border-radius:10px;text-decoration:none;box-shadow:0 4px 20px ${ac}44;transition:all 0.2s">${d.cta_text}</a>
      </div>
    </div>`;

  document.getElementById('previewFrame').innerHTML = html;
}

async function generateCopy() {
  const btn = document.getElementById('aiGenBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Generating...';

  try {
    const res = await fetch('/api/funnels/generate-copy', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        template_type: selectedTemplate,
        niche: document.getElementById('aiNiche').value,
        offer: document.getElementById('aiOffer').value,
      })
    });
    const data = await res.json();
    if(data.headline) document.getElementById('headline').value = data.headline;
    if(data.subheadline) document.getElementById('subheadline').value = data.subheadline;
    if(data.body_copy) document.getElementById('bodyCopy').value = data.body_copy;
    if(data.cta_text) document.getElementById('ctaText').value = data.cta_text;
    updatePreview();
    showToast('AI copy generated!');
  } catch(e) {
    alert('Error generating copy. Please try again.');
  }
  btn.disabled = false;
  btn.textContent = 'ü§ñ Generate Copy with AI';
}

async function savePage(status) {
  const d = getFormData();
  d.id = pageId;
  d.status = status;

  try {
    const res = await fetch('/api/funnels/save', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(d),
    });
    const data = await res.json();
    if(data.success) {
      pageId = data.id;
      if(status === 'published') {
        showToast('Page published! Live at /p/' + data.slug);
      } else {
        showToast('Draft saved!');
      }
      // Update URL if new page
      if(!window.location.pathname.includes('/edit/')) {
        history.replaceState(null, '', '/funnels/edit/' + data.id);
      }
    } else {
      alert(data.error || 'Error saving page');
    }
  } catch(e) {
    alert('Error saving. Please try again.');
  }
}

function showToast(msg) {
  const t = document.getElementById('saveToast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
