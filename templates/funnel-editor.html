<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>{{ 'Edit' if page else 'New' }} Page ‚Äî Funnel Builder</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Rethink+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans','Rethink Sans',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;overflow:hidden}
.editor-layout{display:grid;grid-template-columns:260px 1fr 300px;height:100vh}

/* LEFT: Section Library */
.lib-panel{background:#0a0a1a;border-right:1px solid rgba(0,212,255,0.1);overflow-y:auto;display:flex;flex-direction:column}
.lib-header{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;gap:10px}
.lib-header a{text-decoration:none;display:flex;align-items:center;gap:8px}
.lib-brand{font-weight:800;font-size:16px;letter-spacing:2px;text-transform:uppercase;background:linear-gradient(135deg,#0ea5e9,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.lib-title{padding:14px 18px 8px;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#38bdf8}
.lib-item{display:flex;align-items:center;gap:10px;padding:10px 18px;cursor:pointer;transition:all 0.15s;border-left:2px solid transparent;font-size:16px;color:#6b7d94}
.lib-item:hover{background:rgba(255,255,255,0.04);color:#fff;border-left-color:rgba(0,212,255,0.3)}
.lib-item .li-icon{font-size:16px;width:22px;text-align:center}
.lib-cat{padding:14px 18px 6px;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(0,212,255,0.4);margin-top:6px}

/* CENTER: Canvas */
.canvas-panel{background:#1e293b;display:flex;flex-direction:column;overflow:hidden}
.canvas-toolbar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:#0f172a;border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;height:52px}
.canvas-toolbar .tb-left{display:flex;align-items:center;gap:10px}
.canvas-toolbar .tb-right{display:flex;align-items:center;gap:8px}
.tb-btn{padding:7px 16px;border-radius:6px;font-size:16px;font-weight:700;cursor:pointer;border:none;transition:all 0.15s;font-family:inherit}
.tb-save{background:#16a34a;color:#fff}.tb-save:hover{background:#15803d}
.tb-pub{background:linear-gradient(135deg,#0ea5e9,#38bdf8);color:#fff}.tb-pub:hover{opacity:0.9}
.tb-back{background:transparent;border:1px solid rgba(255,255,255,0.15);color:#6b7d94}.tb-back:hover{color:#fff}
.tb-preview{background:rgba(255,255,255,0.06);color:#6b7d94;border:1px solid rgba(255,255,255,0.1)}.tb-preview:hover{color:#fff}

.canvas-scroll{flex:1;overflow-y:auto;padding:20px}
.canvas-inner{max-width:820px;margin:0 auto;min-height:400px;border-radius:12px;overflow:hidden;position:relative}
.canvas-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px;color:#64748b;text-align:center;padding:40px}
.canvas-empty .ce-icon{font-size:48px;margin-bottom:12px}
.canvas-empty .ce-title{font-size:19px;font-weight:700;margin-bottom:6px}

/* Section wrapper on canvas */
.section-wrap{position:relative;border:2px solid transparent;transition:border-color 0.15s,transform 0.15s,opacity 0.15s;cursor:pointer}
.section-wrap:hover{border-color:rgba(0,212,255,0.3)}
.section-wrap.selected{border-color:#38bdf8}
.section-wrap.dragging{opacity:0.4;border-color:#38bdf8;transform:scale(0.98)}
.section-wrap.drag-over-top{border-top:3px solid #38bdf8}
.section-wrap.drag-over-bottom{border-bottom:3px solid #38bdf8}
.section-controls{position:absolute;top:8px;right:8px;display:none;gap:4px;z-index:10}
.section-wrap:hover .section-controls,.section-wrap.selected .section-controls{display:flex}
.sc-btn{width:28px;height:28px;border-radius:6px;border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.sc-move{background:rgba(0,0,0,0.6);color:#fff}.sc-move:hover{background:rgba(0,0,0,0.8)}
.sc-del{background:rgba(220,38,38,0.8);color:#fff}.sc-del:hover{background:#dc2626}
.sc-drag{background:rgba(0,0,0,0.6);color:#fff;cursor:grab;font-size:12px;letter-spacing:1px}.sc-drag:hover{background:rgba(0,0,0,0.8)}.sc-drag:active{cursor:grabbing}

/* RIGHT: Settings Panel */
.settings-panel{background:#0a0a1a;border-left:1px solid rgba(0,212,255,0.1);overflow-y:auto;padding:0}
.set-header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.06);font-size:16px;font-weight:700;color:#fff}
.set-section{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.04)}
.set-label{font-size:16px;font-weight:600;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.set-input,.set-textarea,.set-select{width:100%;padding:8px 10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e2e8f0;font-size:16px;font-family:inherit;transition:border-color 0.2s}
.set-input:focus,.set-textarea:focus,.set-select:focus{outline:none;border-color:#38bdf8}
.set-textarea{resize:vertical;min-height:60px}
.set-select{appearance:auto}
.set-row{margin-bottom:10px}

/* Color/accent pickers */
.scheme-grid{display:flex;gap:6px}
.scheme-opt{width:32px;height:32px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.scheme-opt:hover{transform:scale(1.1)}
.scheme-opt.active{border-color:#38bdf8}
.accent-grid{display:flex;gap:5px;flex-wrap:wrap}
.accent-opt{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.accent-opt:hover{transform:scale(1.15)}
.accent-opt.active{border-color:#fff;box-shadow:0 0 0 2px #0f172a,0 0 0 4px #fff}

/* AI Generate button */
.ai-gen-section{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.04);background:rgba(124,58,237,0.06)}

/* Item list editors */
.item-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.item-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:10px 12px}
.item-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.item-num{font-size:10px;font-weight:700;color:#38bdf8;letter-spacing:1px}
.item-del{background:none;border:none;color:#64748b;cursor:pointer;font-size:12px;padding:2px 6px;border-radius:4px;transition:all 0.15s}
.item-del:hover{color:#ef4444;background:rgba(239,68,68,0.1)}
.item-field{margin-bottom:6px}
.item-field:last-child{margin-bottom:0}
.item-field-label{font-size:9px;font-weight:600;color:#4a5a6e;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:2px}
.item-field .set-input,.item-field .set-textarea{font-size:12px;padding:6px 8px}
.item-add-btn{width:100%;padding:8px;margin-top:6px;background:transparent;border:1px dashed rgba(56,189,248,0.25);border-radius:6px;color:#38bdf8;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.15s}
.item-add-btn:hover{background:rgba(0,212,255,0.06);border-color:rgba(56,189,248,0.4)}

/* Element layout controls */
.el-layout-list{display:flex;flex-direction:column;gap:4px}
.el-layout-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:8px 10px;transition:all 0.15s}
.el-layout-card.el-hidden{opacity:0.4}
.el-layout-card.el-drag-over{border-color:#38bdf8;background:rgba(56,189,248,0.08)}
.el-layout-row{display:flex;align-items:center;gap:6px}
.el-grip{cursor:grab;color:#4a5a6e;font-size:11px;user-select:none}.el-grip:active{cursor:grabbing}
.el-name{flex:1;font-size:12px;font-weight:600;color:#b0bec5}
.el-vis-btn{background:none;border:none;cursor:pointer;font-size:12px;padding:2px 4px;border-radius:4px;transition:all 0.15s;opacity:0.5}
.el-vis-btn.active{opacity:1}
.el-vis-btn:hover{background:rgba(255,255,255,0.06)}
.el-controls-row{display:flex;align-items:center;gap:10px;margin-top:6px;padding-left:20px}
.el-align-group{display:flex;gap:2px}
.el-align-btn{width:22px;height:20px;border:1px solid rgba(255,255,255,0.1);border-radius:3px;background:transparent;color:#4a5a6e;cursor:pointer;font-size:8px;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.el-align-btn.active{background:rgba(56,189,248,0.15);border-color:#38bdf8;color:#38bdf8}
.el-align-btn:hover{border-color:rgba(0,212,255,0.3)}
.el-spacing-group{display:flex;align-items:center;gap:4px;flex:1}
.el-spacing-slider{flex:1;height:3px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,0.1);border-radius:2px;outline:none}
.el-spacing-slider::-webkit-slider-thumb{-webkit-appearance:none;width:10px;height:10px;border-radius:50%;background:#38bdf8;cursor:pointer}
.ai-btn{width:100%;padding:10px;background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;border:none;border-radius:6px;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.15s}
.ai-btn:hover{opacity:0.9}.ai-btn:disabled{opacity:0.5;cursor:wait}

/* Toast */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(10px);background:#16a34a;color:#fff;padding:10px 24px;border-radius:8px;font-weight:700;font-size:16px;opacity:0;transition:all 0.3s;z-index:999;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

@media(max-width:1000px){.editor-layout{grid-template-columns:1fr}.lib-panel,.settings-panel{display:none}}
</style>
</head>
<body>
<div class="editor-layout">

<!-- LEFT: Section Library -->
<div class="lib-panel">
  <div class="lib-header"><a href="/funnels"><svg width="24" height="24" viewBox="0 0 30 30"><path d="M15 2L3 7v7c0 7.73 5.12 14.95 12 17 6.88-2.05 12-9.27 12-17V7L15 2z" fill="url(#sg)"/><defs><linearGradient id="sg" x1="0" y1="0" x2="30" y2="30"><stop offset="0%" stop-color="#38bdf8"/><stop offset="100%" stop-color="#0ea5e9"/></linearGradient></defs></svg><span class="lib-brand">SuperAdPro</span></a></div>
  <div class="lib-title">Add Sections</div>
  <div id="libSections"></div>
</div>

<!-- CENTER: Canvas -->
<div class="canvas-panel">
  <div class="canvas-toolbar">
    <div class="tb-left">
      <input class="set-input" id="pageTitleInput" placeholder="Page title..." value="{{ page.title if page else '' }}" style="width:220px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);font-weight:600">
    </div>
    <div class="tb-right">
      <button class="tb-btn tb-back" onclick="location.href='/funnels'">‚Üê Back</button>
      <button class="tb-btn tb-preview" onclick="previewPage()">üëÅ Preview</button>
      <button class="tb-btn tb-save" onclick="savePage('draft')">Save Draft</button>
      <button class="tb-btn tb-pub" onclick="savePage('published')">üöÄ Publish</button>
    </div>
  </div>
  <div class="canvas-scroll">
    <div class="canvas-inner" id="canvas" ondragover="onCanvasDragOver(event)" ondrop="onCanvasDrop(event)"></div>
  </div>
</div>

<!-- RIGHT: Settings -->
<div class="settings-panel">
  <div class="set-header">Page Settings</div>

  <!-- Global styles -->
  <div class="set-section">
    <div class="set-row">
      <div class="set-label">Background Theme</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <div class="scheme-grid">
          <div class="scheme-opt active" data-scheme="dark" style="background:#0a0a1a" onclick="setScheme(this)"></div>
          <div class="scheme-opt" data-scheme="light" style="background:#f0f2f8" onclick="setScheme(this)"></div>
          <div class="scheme-opt" data-scheme="gradient" style="background:linear-gradient(135deg,#0a0a1a,#1a1a4a)" onclick="setScheme(this)"></div>
          <div class="scheme-opt" data-scheme="ocean" style="background:linear-gradient(135deg,#0a1628,#0a2840)" onclick="setScheme(this)"></div>
          <div class="scheme-opt" data-scheme="fire" style="background:linear-gradient(135deg,#1a0a0a,#2a1a0a)" onclick="setScheme(this)"></div>
        </div>
        <div style="position:relative">
          <input type="color" id="customBgPicker" value="#0a0a1a" style="position:absolute;opacity:0;width:32px;height:32px;cursor:pointer" oninput="setCustomBg(this.value)">
          <div id="customBgSwatch" onclick="document.getElementById('customBgPicker').click()" style="width:32px;height:32px;border-radius:6px;background:conic-gradient(red,yellow,lime,aqua,blue,magenta,red);cursor:pointer;border:2px solid transparent;transition:all 0.15s;display:flex;align-items:center;justify-content:center" title="Custom background">
            <div style="width:14px;height:14px;background:#1e293b;border-radius:3px"></div>
          </div>
        </div>
      </div>
      <div id="customBgHex" style="display:none;margin-top:4px;font-size:11px;color:#6b7d94;font-family:monospace"></div>
    </div>
    <div class="set-row">
      <div class="set-label">Accent Color</div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <div class="accent-grid">
          <div class="accent-opt active" style="background:#38bdf8" data-color="#38bdf8" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#0ea5e9" data-color="#0ea5e9" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#16a34a" data-color="#16a34a" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#f59e0b" data-color="#f59e0b" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#ef4444" data-color="#ef4444" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#ec4899" data-color="#ec4899" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#f97316" data-color="#f97316" onclick="setAccent(this)"></div>
        </div>
        <div style="position:relative;margin-left:4px">
          <input type="color" id="customAccentPicker" value="#38bdf8" style="position:absolute;opacity:0;width:28px;height:28px;cursor:pointer" oninput="setCustomAccent(this.value)">
          <div id="customAccentSwatch" onclick="document.getElementById('customAccentPicker').click()" style="width:26px;height:26px;border-radius:50%;background:conic-gradient(red,yellow,lime,aqua,blue,magenta,red);cursor:pointer;border:2px solid rgba(255,255,255,0.2);transition:all 0.15s;display:flex;align-items:center;justify-content:center" title="Custom colour">
            <div style="width:10px;height:10px;background:#1e293b;border-radius:50%"></div>
          </div>
        </div>
      </div>
      <div id="customColorHex" style="display:none;margin-top:6px;font-size:11px;color:#6b7d94;font-family:monospace"></div>
    </div>
  </div>

  <!-- AI Copy Generator -->
  <div class="ai-gen-section">
    <div class="set-label" style="color:#38bdf8;margin-bottom:8px">‚ú® AI Copy Generator</div>
    <div class="set-row"><input class="set-input" id="aiNiche" placeholder="Your niche (e.g. Forex)"></div>
    <div class="set-row"><input class="set-input" id="aiOffer" placeholder="What you're promoting"></div>
    <button class="ai-btn" id="aiGenBtn" onclick="aiGenerate()">ü§ñ Generate All Copy with AI</button>
  </div>

  <!-- Section-specific settings (dynamic) -->
  <div id="sectionSettings">
    <div class="set-section" style="text-align:center;padding:40px 18px;color:#4a5a6e">
      <div style="font-size:24px;margin-bottom:8px">üëà</div>
      <div style="font-size:16px">Click a section on the canvas to edit its content</div>
    </div>
  </div>
</div>

</div>

<div class="toast" id="toast"></div>

<script src="/static/js/section-templates.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pageId = {{ page.id if page else 'null' }};
let sections = [];
let selectedIdx = -1;
let scheme = '{{ page.color_scheme if page else "dark" }}';
let accent = '{{ page.accent_color if page else "#38bdf8" }}';
let customBg = '{{ page.custom_bg if page and page.custom_bg else "" }}';

// Load saved sections if editing
{% if page and page.body_copy %}
try { sections = JSON.parse({{ page.body_copy | tojson }}); } catch(e) { console.error('Parse err:', e); sections = []; }
{% endif %}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT: Build section library
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initLibrary() {
  const el = document.getElementById('libSections');
  let html = '';
  SECTION_CATEGORIES.forEach(cat => {
    html += `<div class="lib-cat">${cat.icon} ${cat.name}</div>`;
    SECTION_TEMPLATES.filter(s => s.category === cat.id).forEach(s => {
      html += `<div class="lib-item" onclick="addSection('${s.id}')" draggable="true" ondragstart="onLibDragStart(event,'${s.id}')"><span class="li-icon">${s.icon}</span>${s.name}</div>`;
    });
  });
  el.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getBg() {
  if (scheme === 'custom' && customBg) return `background:${customBg}`;
  const bgs = {dark:'background:#0a0a1a',light:'background:#f5f7fb',gradient:'background:linear-gradient(160deg,#0a0a1a,#1a1a4a,#0a0a2a)',ocean:'background:linear-gradient(160deg,#0a1628,#0a2840,#061420)',fire:'background:linear-gradient(160deg,#1a0a0a,#2a1a0a,#1a0a05)'};
  return bgs[scheme] || bgs.dark;
}

function renderCanvas() {
  const canvas = document.getElementById('canvas');
  canvas.style.cssText = getBg() + ';min-height:400px';

  if (sections.length === 0) {
    canvas.innerHTML = '<div class="canvas-empty"><div class="ce-icon">üöÄ</div><div class="ce-title">Start building your page</div><div>Click any section from the left panel to add it</div></div>';
    return;
  }

  let html = '';
  sections.forEach((sec, i) => {
    const tpl = SECTION_TEMPLATES.find(t => t.id === sec.templateId);
    if (!tpl) return;
    const rendered = tpl.render(sec.data, accent, scheme);
    html += `<div class="section-wrap${i===selectedIdx?' selected':''}" onclick="selectSection(${i})" data-idx="${i}" draggable="true" ondragstart="onDragStart(event,${i})" ondragend="onDragEnd(event)" ondragover="onDragOver(event,${i})" ondragleave="onDragLeave(event)" ondrop="onDrop(event,${i})">
      <div class="section-controls">
        <button class="sc-btn sc-drag" draggable="false" title="Drag to reorder">‚†ø</button>
        ${i > 0 ? `<button class="sc-btn sc-move" onclick="event.stopPropagation();moveSection(${i},-1)" title="Move up">‚Üë</button>` : ''}
        ${i < sections.length-1 ? `<button class="sc-btn sc-move" onclick="event.stopPropagation();moveSection(${i},1)" title="Move down">‚Üì</button>` : ''}
        <button class="sc-btn sc-del" onclick="event.stopPropagation();removeSection(${i})" title="Delete">‚úï</button>
      </div>
      ${rendered}
    </div>`;
  });
  canvas.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SECTION OPERATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addSection(templateId) {
  const tpl = SECTION_TEMPLATES.find(t => t.id === templateId);
  if (!tpl) return;
  sections.push({ templateId, data: JSON.parse(JSON.stringify(tpl.defaultData)) });
  selectedIdx = sections.length - 1;
  renderCanvas();
  renderSectionSettings();
}

function selectSection(idx) {
  selectedIdx = idx;
  renderCanvas();
  renderSectionSettings();
}

function removeSection(idx) {
  sections.splice(idx, 1);
  if (selectedIdx >= sections.length) selectedIdx = sections.length - 1;
  renderCanvas();
  renderSectionSettings();
}

function moveSection(idx, dir) {
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= sections.length) return;
  [sections[idx], sections[newIdx]] = [sections[newIdx], sections[idx]];
  selectedIdx = newIdx;
  renderCanvas();
  renderSectionSettings();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAG & DROP REORDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dragIdx = -1;

function onDragStart(e, idx) {
  dragIdx = idx;
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', idx);
  // Delay adding class so the drag image captures properly
  setTimeout(() => {
    const el = document.querySelector(`.section-wrap[data-idx="${idx}"]`);
    if (el) el.classList.add('dragging');
  }, 0);
}

function onDragEnd(e) {
  dragIdx = -1;
  document.querySelectorAll('.section-wrap').forEach(el => {
    el.classList.remove('dragging', 'drag-over-top', 'drag-over-bottom');
  });
}

function onDragOver(e, idx) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  if (dragIdx === idx) return;
  
  const wrap = e.currentTarget;
  const rect = wrap.getBoundingClientRect();
  const midY = rect.top + rect.height / 2;
  
  // Clear all indicators
  document.querySelectorAll('.section-wrap').forEach(el => {
    el.classList.remove('drag-over-top', 'drag-over-bottom');
  });
  
  // Show indicator based on mouse position
  if (e.clientY < midY) {
    wrap.classList.add('drag-over-top');
  } else {
    wrap.classList.add('drag-over-bottom');
  }
}

function onDragLeave(e) {
  e.currentTarget.classList.remove('drag-over-top', 'drag-over-bottom');
}

function onDrop(e, dropIdx) {
  e.preventDefault();
  document.querySelectorAll('.section-wrap').forEach(el => {
    el.classList.remove('dragging', 'drag-over-top', 'drag-over-bottom');
  });
  
  if (dragIdx < 0 || dragIdx === dropIdx) return;
  
  // Determine if dropping above or below
  const rect = e.currentTarget.getBoundingClientRect();
  const midY = rect.top + rect.height / 2;
  let targetIdx = e.clientY < midY ? dropIdx : dropIdx + 1;
  if (dragIdx < targetIdx) targetIdx--;
  
  // Move the section
  const [moved] = sections.splice(dragIdx, 1);
  sections.splice(targetIdx, 0, moved);
  
  // Update selected
  if (selectedIdx === dragIdx) {
    selectedIdx = targetIdx;
  } else if (dragIdx < selectedIdx && targetIdx >= selectedIdx) {
    selectedIdx--;
  } else if (dragIdx > selectedIdx && targetIdx <= selectedIdx) {
    selectedIdx++;
  }
  
  dragIdx = -1;
  renderCanvas();
  renderSectionSettings();
}

// Library item drag onto canvas
let libDragTemplateId = null;

function onLibDragStart(e, templateId) {
  libDragTemplateId = templateId;
  dragIdx = -1; // Not a reorder drag
  e.dataTransfer.effectAllowed = 'copy';
  e.dataTransfer.setData('text/template', templateId);
}

function onCanvasDragOver(e) {
  if (libDragTemplateId) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
  }
}

function onCanvasDrop(e) {
  if (libDragTemplateId) {
    e.preventDefault();
    addSection(libDragTemplateId);
    libDragTemplateId = null;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SECTION SETTINGS (right panel)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSectionSettings() {
  const el = document.getElementById('sectionSettings');
  if (selectedIdx < 0 || selectedIdx >= sections.length) {
    el.innerHTML = '<div class="set-section" style="text-align:center;padding:40px 18px;color:#4a5a6e"><div style="font-size:24px;margin-bottom:8px">üëà</div><div style="font-size:16px">Click a section to edit</div></div>';
    return;
  }
  const sec = sections[selectedIdx];
  const tpl = SECTION_TEMPLATES.find(t => t.id === sec.templateId);
  if (!tpl) return;

  let html = `<div class="set-section"><div style="font-size:16px;font-weight:700;color:#38bdf8;margin-bottom:4px">${tpl.icon} ${tpl.name}</div></div>`;

  // Generate form fields based on data keys
  html += '<div class="set-section">';
  const data = sec.data;
  for (const [key, val] of Object.entries(data)) {
    if (key.startsWith('_')) continue; // Skip internal layout keys
    const label = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    if (typeof val === 'string') {
      if (val.length > 80 || key === 'text' || key === 'bullets' || key === 'body_copy') {
        html += `<div class="set-row"><div class="set-label">${label}</div><textarea class="set-textarea" onchange="updateField(${selectedIdx},'${key}',this.value)" oninput="updateField(${selectedIdx},'${key}',this.value)">${val}</textarea></div>`;
      } else {
        html += `<div class="set-row"><div class="set-label">${label}</div><input class="set-input" value="${val.replace(/"/g,'&quot;')}" onchange="updateField(${selectedIdx},'${key}',this.value)" oninput="updateField(${selectedIdx},'${key}',this.value)"></div>`;
      }
    } else if (typeof val === 'boolean') {
      html += `<div class="set-row"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:16px;color:#6b7d94"><input type="checkbox" ${val?'checked':''} onchange="updateField(${selectedIdx},'${key}',this.checked)"> ${label}</label></div>`;
    } else if (typeof val === 'number') {
      html += `<div class="set-row"><div class="set-label">${label}</div><input class="set-input" type="number" value="${val}" onchange="updateField(${selectedIdx},'${key}',Number(this.value))" oninput="updateField(${selectedIdx},'${key}',Number(this.value))"></div>`;
    } else if (Array.isArray(val)) {
      html += `<div class="set-row"><div class="set-label">${label} (${val.length} items)</div>`;
      html += `<div class="item-list" id="items_${key}">`;
      val.forEach((item, itemIdx) => {
        html += `<div class="item-card">`;
        html += `<div class="item-card-header"><span class="item-num">#${itemIdx+1}</span><button class="item-del" onclick="removeArrayItem(${selectedIdx},'${key}',${itemIdx})" title="Remove">‚úï</button></div>`;
        if (typeof item === 'object' && item !== null) {
          for (const [fk, fv] of Object.entries(item)) {
            const fLabel = fk.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            if (typeof fv === 'string') {
              if (fv.length > 60 || fk === 'text' || fk === 'desc' || fk === 'a') {
                html += `<div class="item-field"><div class="item-field-label">${fLabel}</div><textarea class="set-textarea" rows="2" oninput="updateArrayItemField(${selectedIdx},'${key}',${itemIdx},'${fk}',this.value)">${fv}</textarea></div>`;
              } else {
                html += `<div class="item-field"><div class="item-field-label">${fLabel}</div><input class="set-input" value="${String(fv).replace(/"/g,'&quot;')}" oninput="updateArrayItemField(${selectedIdx},'${key}',${itemIdx},'${fk}',this.value)"></div>`;
              }
            } else if (typeof fv === 'number') {
              html += `<div class="item-field"><div class="item-field-label">${fLabel}</div><input class="set-input" type="number" value="${fv}" oninput="updateArrayItemField(${selectedIdx},'${key}',${itemIdx},'${fk}',Number(this.value))"></div>`;
            }
          }
        }
        html += `</div>`;
      });
      html += `</div>`;
      // Add item button
      html += `<button class="item-add-btn" onclick="addArrayItem(${selectedIdx},'${key}')">+ Add Item</button>`;
      html += `</div>`;
    }
  }
  html += '</div>';

  // ‚îÄ‚îÄ ELEMENT LAYOUT CONTROLS ‚îÄ‚îÄ
  if (tpl.elements && tpl.elements.length > 1) {
    const order = sec.data._elementOrder || tpl.elements;
    if (!sec.data._elementStyles) sec.data._elementStyles = {};

    html += '<div class="set-section">';
    html += '<div class="set-label" style="margin-bottom:8px;color:#38bdf8;font-weight:700">‚öô Element Layout</div>';
    html += '<div class="set-label" style="font-size:9px;color:#4a5a6e;margin-bottom:8px">Drag to reorder ¬∑ Toggle visibility ¬∑ Set alignment</div>';
    html += '<div class="el-layout-list" id="elLayoutList">';

    order.forEach((elName, elIdx) => {
      const s = elStyle(sec.data, elName);
      const label = elName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      html += `<div class="el-layout-card${s.visible?'':' el-hidden'}" draggable="true" data-el="${elName}" ondragstart="onElDragStart(event,'${elName}')" ondragend="onElDragEnd(event)" ondragover="onElDragOver(event,'${elName}')" ondragleave="onElDragLeave(event)" ondrop="onElDrop(event,'${elName}')">`;
      html += `<div class="el-layout-row">`;
      html += `<span class="el-grip" title="Drag to reorder">‚†ø</span>`;
      html += `<span class="el-name">${label}</span>`;
      html += `<button class="el-vis-btn${s.visible?' active':''}" onclick="toggleElVisibility(${selectedIdx},'${elName}')" title="${s.visible?'Hide':'Show'}">${s.visible?'üëÅ':'üëÅ‚Äçüó®'}</button>`;
      html += `</div>`;
      if (s.visible) {
        html += `<div class="el-controls-row">`;
        html += `<div class="el-align-group">`;
        html += `<button class="el-align-btn${s.align==='left'?' active':''}" onclick="setElAlign(${selectedIdx},'${elName}','left')" title="Left">‚óÄ</button>`;
        html += `<button class="el-align-btn${s.align==='center'?' active':''}" onclick="setElAlign(${selectedIdx},'${elName}','center')" title="Center">‚óè</button>`;
        html += `<button class="el-align-btn${s.align==='right'?' active':''}" onclick="setElAlign(${selectedIdx},'${elName}','right')" title="Right">‚ñ∂</button>`;
        html += `</div>`;
        html += `<div class="el-spacing-group">`;
        html += `<span style="font-size:9px;color:#4a5a6e">Gap</span>`;
        html += `<input type="range" min="0" max="64" value="${s.spacing}" class="el-spacing-slider" oninput="setElSpacing(${selectedIdx},'${elName}',Number(this.value))">`;
        html += `<span style="font-size:10px;color:#6b7d94;width:24px;text-align:right">${s.spacing}</span>`;
        html += `</div>`;
        html += `</div>`;
      }
      html += `</div>`;
    });

    html += '</div></div>';
  }

  el.innerHTML = html;
}

function updateField(idx, key, val) {
  if (idx >= 0 && idx < sections.length) {
    sections[idx].data[key] = val;
    renderCanvas();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ELEMENT LAYOUT CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ensureElStyles(idx) {
  if (!sections[idx].data._elementStyles) sections[idx].data._elementStyles = {};
}

function toggleElVisibility(idx, elName) {
  ensureElStyles(idx);
  const styles = sections[idx].data._elementStyles;
  if (!styles[elName]) styles[elName] = {};
  styles[elName].visible = styles[elName].visible === false ? true : false;
  renderCanvas();
  renderSectionSettings();
}

function setElAlign(idx, elName, align) {
  ensureElStyles(idx);
  const styles = sections[idx].data._elementStyles;
  if (!styles[elName]) styles[elName] = {};
  styles[elName].align = align;
  renderCanvas();
  renderSectionSettings();
}

function setElSpacing(idx, elName, px) {
  ensureElStyles(idx);
  const styles = sections[idx].data._elementStyles;
  if (!styles[elName]) styles[elName] = {};
  styles[elName].spacing = px;
  renderCanvas();
}

// Element drag reorder within section
let elDragName = null;

function onElDragStart(e, elName) {
  elDragName = elName;
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/element', elName);
}

function onElDragEnd(e) {
  elDragName = null;
  document.querySelectorAll('.el-layout-card').forEach(c => c.classList.remove('el-drag-over'));
}

function onElDragOver(e, elName) {
  if (!elDragName || elDragName === elName) return;
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  document.querySelectorAll('.el-layout-card').forEach(c => c.classList.remove('el-drag-over'));
  e.currentTarget.classList.add('el-drag-over');
}

function onElDragLeave(e) {
  e.currentTarget.classList.remove('el-drag-over');
}

function onElDrop(e, targetElName) {
  e.preventDefault();
  document.querySelectorAll('.el-layout-card').forEach(c => c.classList.remove('el-drag-over'));
  if (!elDragName || elDragName === targetElName || selectedIdx < 0) return;

  const sec = sections[selectedIdx];
  const tpl = SECTION_TEMPLATES.find(t => t.id === sec.templateId);
  const order = sec.data._elementOrder || [...tpl.elements];
  
  const fromIdx = order.indexOf(elDragName);
  const toIdx = order.indexOf(targetElName);
  if (fromIdx < 0 || toIdx < 0) return;
  
  order.splice(fromIdx, 1);
  order.splice(toIdx, 0, elDragName);
  sec.data._elementOrder = order;
  
  elDragName = null;
  renderCanvas();
  renderSectionSettings();
}

function updateArrayField(idx, key, val) {
  try {
    sections[idx].data[key] = JSON.parse(val);
    renderCanvas();
  } catch(e) { /* ignore parse errors while typing */ }
}

function updateArrayItemField(idx, key, itemIdx, fieldKey, val) {
  if (idx >= 0 && idx < sections.length) {
    sections[idx].data[key][itemIdx][fieldKey] = val;
    renderCanvas();
  }
}

function removeArrayItem(idx, key, itemIdx) {
  if (idx >= 0 && idx < sections.length) {
    sections[idx].data[key].splice(itemIdx, 1);
    renderCanvas();
    renderSectionSettings();
  }
}

function addArrayItem(idx, key) {
  if (idx >= 0 && idx < sections.length) {
    const arr = sections[idx].data[key];
    if (arr.length === 0) return;
    // Clone the first item as a template, clear string values
    const template = JSON.parse(JSON.stringify(arr[0]));
    for (const k of Object.keys(template)) {
      if (typeof template[k] === 'string') template[k] = '';
    }
    arr.push(template);
    renderCanvas();
    renderSectionSettings();
    // Scroll to bottom of settings
    const el = document.getElementById('sectionSettings');
    setTimeout(() => el.scrollTop = el.scrollHeight, 50);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL STYLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setScheme(el) {
  document.querySelectorAll('.scheme-opt').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  scheme = el.dataset.scheme;
  customBg = '';
  document.getElementById('customBgHex').style.display = 'none';
  document.getElementById('customBgSwatch').style.borderColor = 'transparent';
  renderCanvas();
}

function setCustomBg(color) {
  document.querySelectorAll('.scheme-opt').forEach(e => e.classList.remove('active'));
  scheme = 'custom';
  customBg = color;
  const hexEl = document.getElementById('customBgHex');
  hexEl.textContent = color.toUpperCase();
  hexEl.style.display = 'block';
  document.getElementById('customBgSwatch').style.borderColor = '#38bdf8';
  renderCanvas();
}

function setAccent(el) {
  document.querySelectorAll('.accent-opt').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  accent = el.dataset.color;
  document.getElementById('customAccentPicker').value = accent;
  document.getElementById('customColorHex').style.display = 'none';
  renderCanvas();
}

function setCustomAccent(color) {
  document.querySelectorAll('.accent-opt').forEach(e => e.classList.remove('active'));
  accent = color;
  const hexEl = document.getElementById('customColorHex');
  hexEl.textContent = color.toUpperCase();
  hexEl.style.display = 'block';
  renderCanvas();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AI GENERATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function aiGenerate() {
  const btn = document.getElementById('aiGenBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Generating...';
  try {
    const res = await fetch('/api/funnels/generate-copy', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        template_type: 'opportunity',
        niche: document.getElementById('aiNiche').value,
        offer: document.getElementById('aiOffer').value,
      })
    });
    const data = await res.json();
    // Apply AI copy to matching sections
    sections.forEach(sec => {
      if (sec.data.headline !== undefined && data.headline) sec.data.headline = data.headline;
      if (sec.data.subheadline !== undefined && data.subheadline) sec.data.subheadline = data.subheadline;
      if (sec.data.bullets !== undefined && data.body_copy) sec.data.bullets = data.body_copy;
      if (sec.data.cta_text !== undefined && data.cta_text) sec.data.cta_text = data.cta_text;
    });
    renderCanvas();
    renderSectionSettings();
    showToast('AI copy applied to all sections!');
  } catch(e) { showToast('Error generating copy'); }
  btn.disabled = false; btn.textContent = 'ü§ñ Generate All Copy with AI';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAVE / PUBLISH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function savePage(status, openPreview) {
  const title = document.getElementById('pageTitleInput').value || 'My Page';
  try {
    const res = await fetch('/api/funnels/save', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        id: pageId, title, status,
        template_type: 'sections',
        body_copy: JSON.stringify(sections),
        color_scheme: scheme,
        accent_color: accent,
        custom_bg: customBg,
        headline: sections[0]?.data?.headline || title,
        subheadline: sections[0]?.data?.subheadline || '',
        cta_text: sections.find(s=>s.data.cta_text)?.data?.cta_text || '',
        cta_url: sections.find(s=>s.data.cta_url)?.data?.cta_url || '',
      })
    });
    const data = await res.json();
    if (data.success) {
      pageId = data.id;
      pageSlug = data.slug;
      if (!location.pathname.includes('/edit/')) history.replaceState(null,'','/funnels/edit/'+data.id);
      if (openPreview) {
        window.open('/p/'+data.slug, '_blank');
      } else if (status === 'published') {
        showUrlBanner(data.slug);
        showToast('Page published!');
      } else {
        showToast('Draft saved!');
      }
    } else showToast(data.error || 'Error saving');
  } catch(e) { showToast('Error saving'); }
}

function showUrlBanner(slug) {
  const fullUrl = window.location.origin + '/p/' + slug;
  let banner = document.getElementById('urlBanner');
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'urlBanner';
    document.body.appendChild(banner);
  }
  banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:10000;background:linear-gradient(135deg,#059669,#10b981);padding:14px 24px;display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;box-shadow:0 4px 20px rgba(0,0,0,0.3);animation:slideDown .3s ease';
  banner.innerHTML = '<span style="color:#fff;font-weight:700;font-size:16px">üöÄ Your page is LIVE!</span>'
    + '<div style="display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.2);border-radius:8px;padding:6px 12px">'
    + '<input id="urlCopyInput" readonly value="'+fullUrl+'" style="background:none;border:none;color:#fff;font-size:16px;font-family:monospace;width:'+Math.min(fullUrl.length*8.5,400)+'px;outline:none">'
    + '<button onclick="copyPageUrl()" style="background:#fff;color:#059669;border:none;border-radius:6px;padding:6px 14px;font-weight:700;font-size:16px;cursor:pointer;font-family:inherit;white-space:nowrap">üìã Copy URL</button>'
    + '</div>'
    + '<a href="/p/'+slug+'" target="_blank" style="color:#fff;font-size:16px;text-decoration:underline;white-space:nowrap">Open page ‚Üí</a>'
    + '<button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(255,255,255,0.7);font-size:20px;cursor:pointer;margin-left:8px">√ó</button>';
}

function copyPageUrl() {
  const input = document.getElementById('urlCopyInput');
  if (input) {
    navigator.clipboard.writeText(input.value).then(() => showToast('URL copied to clipboard!')).catch(() => {
      input.select(); document.execCommand('copy'); showToast('URL copied!');
    });
  }
}

function previewPage() {
  if (!pageSlug && !pageId) { showToast('Save your page first to preview'); return; }
  savePage('draft', true);
}

let pageSlug = '{{ page.slug if page else "" }}';

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  // Set initial scheme/accent from saved data
  document.querySelectorAll('.scheme-opt').forEach(e => e.classList.toggle('active', e.dataset.scheme === scheme));
  document.querySelectorAll('.accent-opt').forEach(e => e.classList.toggle('active', e.dataset.color === accent));
  document.getElementById('customAccentPicker').value = accent;
  // Restore custom bg if saved
  if (scheme === 'custom' && customBg) {
    document.getElementById('customBgPicker').value = customBg;
    document.getElementById('customBgHex').textContent = customBg.toUpperCase();
    document.getElementById('customBgHex').style.display = 'block';
    document.getElementById('customBgSwatch').style.borderColor = '#38bdf8';
  }
  initLibrary();
  renderCanvas();
});
</script>
</body>
</html>
