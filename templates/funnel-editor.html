<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>{{ 'Edit' if page else 'New' }} Page â€” Funnel Builder</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Rethink+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans','Rethink Sans',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;overflow:hidden}
.editor-layout{display:grid;grid-template-columns:260px 1fr 300px;height:100vh}

/* LEFT: Section Library */
.lib-panel{background:#0a0a1a;border-right:1px solid rgba(0,212,255,0.1);overflow-y:auto;display:flex;flex-direction:column}
.lib-header{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;gap:10px}
.lib-header a{text-decoration:none;display:flex;align-items:center;gap:8px}
.lib-brand{font-weight:800;font-size:16px;letter-spacing:2px;text-transform:uppercase;background:linear-gradient(135deg,#00d4ff,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.lib-title{padding:14px 18px 8px;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#00d4ff}
.lib-item{display:flex;align-items:center;gap:10px;padding:10px 18px;cursor:pointer;transition:all 0.15s;border-left:2px solid transparent;font-size:16px;color:#6b7d94}
.lib-item:hover{background:rgba(255,255,255,0.04);color:#fff;border-left-color:rgba(0,212,255,0.3)}
.lib-item .li-icon{font-size:16px;width:22px;text-align:center}
.lib-cat{padding:14px 18px 6px;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(0,212,255,0.4);margin-top:6px}

/* CENTER: Canvas */
.canvas-panel{background:#1e293b;display:flex;flex-direction:column;overflow:hidden}
.canvas-toolbar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:#0f172a;border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;height:52px}
.canvas-toolbar .tb-left{display:flex;align-items:center;gap:10px}
.canvas-toolbar .tb-right{display:flex;align-items:center;gap:8px}
.tb-btn{padding:7px 16px;border-radius:6px;font-size:16px;font-weight:700;cursor:pointer;border:none;transition:all 0.15s;font-family:inherit}
.tb-save{background:#16a34a;color:#fff}.tb-save:hover{background:#15803d}
.tb-pub{background:linear-gradient(135deg,#00b4d8,#6d28d9);color:#fff}.tb-pub:hover{opacity:0.9}
.tb-back{background:transparent;border:1px solid rgba(255,255,255,0.15);color:#6b7d94}.tb-back:hover{color:#fff}
.tb-preview{background:rgba(255,255,255,0.06);color:#6b7d94;border:1px solid rgba(255,255,255,0.1)}.tb-preview:hover{color:#fff}

.canvas-scroll{flex:1;overflow-y:auto;padding:20px}
.canvas-inner{max-width:820px;margin:0 auto;min-height:400px;border-radius:12px;overflow:hidden;position:relative}
.canvas-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px;color:#64748b;text-align:center;padding:40px}
.canvas-empty .ce-icon{font-size:48px;margin-bottom:12px}
.canvas-empty .ce-title{font-size:19px;font-weight:700;margin-bottom:6px}

/* Section wrapper on canvas */
.section-wrap{position:relative;border:2px solid transparent;transition:border-color 0.15s;cursor:pointer}
.section-wrap:hover{border-color:rgba(0,212,255,0.3)}
.section-wrap.selected{border-color:#00d4ff}
.section-controls{position:absolute;top:8px;right:8px;display:none;gap:4px;z-index:10}
.section-wrap:hover .section-controls,.section-wrap.selected .section-controls{display:flex}
.sc-btn{width:28px;height:28px;border-radius:6px;border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.sc-move{background:rgba(0,0,0,0.6);color:#fff}.sc-move:hover{background:rgba(0,0,0,0.8)}
.sc-del{background:rgba(220,38,38,0.8);color:#fff}.sc-del:hover{background:#dc2626}

/* RIGHT: Settings Panel */
.settings-panel{background:#0a0a1a;border-left:1px solid rgba(0,212,255,0.1);overflow-y:auto;padding:0}
.set-header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.06);font-size:16px;font-weight:700;color:#fff}
.set-section{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.04)}
.set-label{font-size:16px;font-weight:600;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.set-input,.set-textarea,.set-select{width:100%;padding:8px 10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e2e8f0;font-size:16px;font-family:inherit;transition:border-color 0.2s}
.set-input:focus,.set-textarea:focus,.set-select:focus{outline:none;border-color:#00d4ff}
.set-textarea{resize:vertical;min-height:60px}
.set-select{appearance:auto}
.set-row{margin-bottom:10px}

/* Color/accent pickers */
.scheme-grid{display:flex;gap:6px}
.scheme-opt{width:32px;height:32px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.scheme-opt:hover{transform:scale(1.1)}
.scheme-opt.active{border-color:#00d4ff}
.accent-grid{display:flex;gap:5px;flex-wrap:wrap}
.accent-opt{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.accent-opt:hover{transform:scale(1.15)}
.accent-opt.active{border-color:#fff;box-shadow:0 0 0 2px #0f172a,0 0 0 4px #fff}

/* AI Generate button */
.ai-gen-section{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.04);background:rgba(124,58,237,0.06)}

/* Item list editors */
.item-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.item-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:10px 12px}
.item-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.item-num{font-size:10px;font-weight:700;color:#00d4ff;letter-spacing:1px}
.item-del{background:none;border:none;color:#64748b;cursor:pointer;font-size:12px;padding:2px 6px;border-radius:4px;transition:all 0.15s}
.item-del:hover{color:#ef4444;background:rgba(239,68,68,0.1)}
.item-field{margin-bottom:6px}
.item-field:last-child{margin-bottom:0}
.item-field-label{font-size:9px;font-weight:600;color:#4a5a6e;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:2px}
.item-field .set-input,.item-field .set-textarea{font-size:12px;padding:6px 8px}
.item-add-btn{width:100%;padding:8px;margin-top:6px;background:transparent;border:1px dashed rgba(0,212,255,0.25);border-radius:6px;color:#00d4ff;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.15s}
.item-add-btn:hover{background:rgba(0,212,255,0.06);border-color:rgba(0,212,255,0.4)}
.ai-btn{width:100%;padding:10px;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border:none;border-radius:6px;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.15s}
.ai-btn:hover{opacity:0.9}.ai-btn:disabled{opacity:0.5;cursor:wait}

/* Toast */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(10px);background:#16a34a;color:#fff;padding:10px 24px;border-radius:8px;font-weight:700;font-size:16px;opacity:0;transition:all 0.3s;z-index:999;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

@media(max-width:1000px){.editor-layout{grid-template-columns:1fr}.lib-panel,.settings-panel{display:none}}
</style>
</head>
<body>
<div class="editor-layout">

<!-- LEFT: Section Library -->
<div class="lib-panel">
  <div class="lib-header"><a href="/funnels"><svg width="24" height="24" viewBox="0 0 30 30"><path d="M15 2L3 7v7c0 7.73 5.12 14.95 12 17 6.88-2.05 12-9.27 12-17V7L15 2z" fill="url(#sg)"/><defs><linearGradient id="sg" x1="0" y1="0" x2="30" y2="30"><stop offset="0%" stop-color="#00d4ff"/><stop offset="100%" stop-color="#7c3aed"/></linearGradient></defs></svg><span class="lib-brand">SuperAdPro</span></a></div>
  <div class="lib-title">Add Sections</div>
  <div id="libSections"></div>
</div>

<!-- CENTER: Canvas -->
<div class="canvas-panel">
  <div class="canvas-toolbar">
    <div class="tb-left">
      <input class="set-input" id="pageTitleInput" placeholder="Page title..." value="{{ page.title if page else '' }}" style="width:220px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);font-weight:600">
    </div>
    <div class="tb-right">
      <button class="tb-btn tb-back" onclick="location.href='/funnels'">â† Back</button>
      <button class="tb-btn tb-preview" onclick="previewPage()">ğŸ‘ Preview</button>
      <button class="tb-btn tb-save" onclick="savePage('draft')">Save Draft</button>
      <button class="tb-btn tb-pub" onclick="savePage('published')">ğŸš€ Publish</button>
    </div>
  </div>
  <div class="canvas-scroll">
    <div class="canvas-inner" id="canvas"></div>
  </div>
</div>

<!-- RIGHT: Settings -->
<div class="settings-panel">
  <div class="set-header">Page Settings</div>

  <!-- Global styles -->
  <div class="set-section">
    <div class="set-row">
      <div class="set-label">Background Theme</div>
      <div class="scheme-grid">
        <div class="scheme-opt active" data-scheme="dark" style="background:#0a0a1a" onclick="setScheme(this)"></div>
        <div class="scheme-opt" data-scheme="light" style="background:#f0f2f8" onclick="setScheme(this)"></div>
        <div class="scheme-opt" data-scheme="gradient" style="background:linear-gradient(135deg,#0a0a1a,#1a1a4a)" onclick="setScheme(this)"></div>
        <div class="scheme-opt" data-scheme="ocean" style="background:linear-gradient(135deg,#0a1628,#0a2840)" onclick="setScheme(this)"></div>
        <div class="scheme-opt" data-scheme="fire" style="background:linear-gradient(135deg,#1a0a0a,#2a1a0a)" onclick="setScheme(this)"></div>
      </div>
    </div>
    <div class="set-row">
      <div class="set-label">Accent Color</div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <div class="accent-grid">
          <div class="accent-opt active" style="background:#00d4ff" data-color="#00d4ff" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#7c3aed" data-color="#7c3aed" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#16a34a" data-color="#16a34a" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#f59e0b" data-color="#f59e0b" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#ef4444" data-color="#ef4444" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#ec4899" data-color="#ec4899" onclick="setAccent(this)"></div>
          <div class="accent-opt" style="background:#f97316" data-color="#f97316" onclick="setAccent(this)"></div>
        </div>
        <div style="position:relative;margin-left:4px">
          <input type="color" id="customAccentPicker" value="#00d4ff" style="position:absolute;opacity:0;width:28px;height:28px;cursor:pointer" oninput="setCustomAccent(this.value)">
          <div id="customAccentSwatch" onclick="document.getElementById('customAccentPicker').click()" style="width:26px;height:26px;border-radius:50%;background:conic-gradient(red,yellow,lime,aqua,blue,magenta,red);cursor:pointer;border:2px solid rgba(255,255,255,0.2);transition:all 0.15s;display:flex;align-items:center;justify-content:center" title="Custom colour">
            <div style="width:10px;height:10px;background:#1e293b;border-radius:50%"></div>
          </div>
        </div>
      </div>
      <div id="customColorHex" style="display:none;margin-top:6px;font-size:11px;color:#6b7d94;font-family:monospace"></div>
    </div>
  </div>

  <!-- AI Copy Generator -->
  <div class="ai-gen-section">
    <div class="set-label" style="color:#a78bfa;margin-bottom:8px">âœ¨ AI Copy Generator</div>
    <div class="set-row"><input class="set-input" id="aiNiche" placeholder="Your niche (e.g. Forex)"></div>
    <div class="set-row"><input class="set-input" id="aiOffer" placeholder="What you're promoting"></div>
    <button class="ai-btn" id="aiGenBtn" onclick="aiGenerate()">ğŸ¤– Generate All Copy with AI</button>
  </div>

  <!-- Section-specific settings (dynamic) -->
  <div id="sectionSettings">
    <div class="set-section" style="text-align:center;padding:40px 18px;color:#4a5a6e">
      <div style="font-size:24px;margin-bottom:8px">ğŸ‘ˆ</div>
      <div style="font-size:16px">Click a section on the canvas to edit its content</div>
    </div>
  </div>
</div>

</div>

<div class="toast" id="toast"></div>

<script src="/static/js/section-templates.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pageId = {{ page.id if page else 'null' }};
let sections = [];
let selectedIdx = -1;
let scheme = '{{ page.color_scheme if page else "dark" }}';
let accent = '{{ page.accent_color if page else "#00d4ff" }}';

// Load saved sections if editing
{% if page and page.body_copy %}
try { sections = JSON.parse('{{ page.body_copy | replace("'", "\\'") | replace("\\n", "\\\\n") }}'); } catch(e) { sections = []; }
{% endif %}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT: Build section library
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initLibrary() {
  const el = document.getElementById('libSections');
  let html = '';
  SECTION_CATEGORIES.forEach(cat => {
    html += `<div class="lib-cat">${cat.icon} ${cat.name}</div>`;
    SECTION_TEMPLATES.filter(s => s.category === cat.id).forEach(s => {
      html += `<div class="lib-item" onclick="addSection('${s.id}')"><span class="li-icon">${s.icon}</span>${s.name}</div>`;
    });
  });
  el.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getBg() {
  const bgs = {dark:'background:#0a0a1a',light:'background:#f5f7fb',gradient:'background:linear-gradient(160deg,#0a0a1a,#1a1a4a,#0a0a2a)',ocean:'background:linear-gradient(160deg,#0a1628,#0a2840,#061420)',fire:'background:linear-gradient(160deg,#1a0a0a,#2a1a0a,#1a0a05)'};
  return bgs[scheme] || bgs.dark;
}

function renderCanvas() {
  const canvas = document.getElementById('canvas');
  canvas.style.cssText = getBg() + ';min-height:400px';

  if (sections.length === 0) {
    canvas.innerHTML = '<div class="canvas-empty"><div class="ce-icon">ğŸš€</div><div class="ce-title">Start building your page</div><div>Click any section from the left panel to add it</div></div>';
    return;
  }

  let html = '';
  sections.forEach((sec, i) => {
    const tpl = SECTION_TEMPLATES.find(t => t.id === sec.templateId);
    if (!tpl) return;
    const rendered = tpl.render(sec.data, accent, scheme);
    html += `<div class="section-wrap${i===selectedIdx?' selected':''}" onclick="selectSection(${i})" data-idx="${i}">
      <div class="section-controls">
        ${i > 0 ? `<button class="sc-btn sc-move" onclick="event.stopPropagation();moveSection(${i},-1)" title="Move up">â†‘</button>` : ''}
        ${i < sections.length-1 ? `<button class="sc-btn sc-move" onclick="event.stopPropagation();moveSection(${i},1)" title="Move down">â†“</button>` : ''}
        <button class="sc-btn sc-del" onclick="event.stopPropagation();removeSection(${i})" title="Delete">âœ•</button>
      </div>
      ${rendered}
    </div>`;
  });
  canvas.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SECTION OPERATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSection(templateId) {
  const tpl = SECTION_TEMPLATES.find(t => t.id === templateId);
  if (!tpl) return;
  sections.push({ templateId, data: JSON.parse(JSON.stringify(tpl.defaultData)) });
  selectedIdx = sections.length - 1;
  renderCanvas();
  renderSectionSettings();
}

function selectSection(idx) {
  selectedIdx = idx;
  renderCanvas();
  renderSectionSettings();
}

function removeSection(idx) {
  sections.splice(idx, 1);
  if (selectedIdx >= sections.length) selectedIdx = sections.length - 1;
  renderCanvas();
  renderSectionSettings();
}

function moveSection(idx, dir) {
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= sections.length) return;
  [sections[idx], sections[newIdx]] = [sections[newIdx], sections[idx]];
  selectedIdx = newIdx;
  renderCanvas();
  renderSectionSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SECTION SETTINGS (right panel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSectionSettings() {
  const el = document.getElementById('sectionSettings');
  if (selectedIdx < 0 || selectedIdx >= sections.length) {
    el.innerHTML = '<div class="set-section" style="text-align:center;padding:40px 18px;color:#4a5a6e"><div style="font-size:24px;margin-bottom:8px">ğŸ‘ˆ</div><div style="font-size:16px">Click a section to edit</div></div>';
    return;
  }
  const sec = sections[selectedIdx];
  const tpl = SECTION_TEMPLATES.find(t => t.id === sec.templateId);
  if (!tpl) return;

  let html = `<div class="set-section"><div style="font-size:16px;font-weight:700;color:#00d4ff;margin-bottom:4px">${tpl.icon} ${tpl.name}</div></div>`;

  // Generate form fields based on data keys
  html += '<div class="set-section">';
  const data = sec.data;
  for (const [key, val] of Object.entries(data)) {
    const label = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    if (typeof val === 'string') {
      if (val.length > 80 || key === 'text' || key === 'bullets' || key === 'body_copy') {
        html += `<div class="set-row"><div class="set-label">${label}</div><textarea class="set-textarea" onchange="updateField(${selectedIdx},'${key}',this.value)" oninput="updateField(${selectedIdx},'${key}',this.value)">${val}</textarea></div>`;
      } else {
        html += `<div class="set-row"><div class="set-label">${label}</div><input class="set-input" value="${val.replace(/"/g,'&quot;')}" onchange="updateField(${selectedIdx},'${key}',this.value)" oninput="updateField(${selectedIdx},'${key}',this.value)"></div>`;
      }
    } else if (typeof val === 'boolean') {
      html += `<div class="set-row"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:16px;color:#6b7d94"><input type="checkbox" ${val?'checked':''} onchange="updateField(${selectedIdx},'${key}',this.checked)"> ${label}</label></div>`;
    } else if (typeof val === 'number') {
      html += `<div class="set-row"><div class="set-label">${label}</div><input class="set-input" type="number" value="${val}" onchange="updateField(${selectedIdx},'${key}',Number(this.value))" oninput="updateField(${selectedIdx},'${key}',Number(this.value))"></div>`;
    } else if (Array.isArray(val)) {
      html += `<div class="set-row"><div class="set-label">${label} (${val.length} items)</div>`;
      html += `<div class="item-list" id="items_${key}">`;
      val.forEach((item, itemIdx) => {
        html += `<div class="item-card">`;
        html += `<div class="item-card-header"><span class="item-num">#${itemIdx+1}</span><button class="item-del" onclick="removeArrayItem(${selectedIdx},'${key}',${itemIdx})" title="Remove">âœ•</button></div>`;
        if (typeof item === 'object' && item !== null) {
          for (const [fk, fv] of Object.entries(item)) {
            const fLabel = fk.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            if (typeof fv === 'string') {
              if (fv.length > 60 || fk === 'text' || fk === 'desc' || fk === 'a') {
                html += `<div class="item-field"><div class="item-field-label">${fLabel}</div><textarea class="set-textarea" rows="2" oninput="updateArrayItemField(${selectedIdx},'${key}',${itemIdx},'${fk}',this.value)">${fv}</textarea></div>`;
              } else {
                html += `<div class="item-field"><div class="item-field-label">${fLabel}</div><input class="set-input" value="${String(fv).replace(/"/g,'&quot;')}" oninput="updateArrayItemField(${selectedIdx},'${key}',${itemIdx},'${fk}',this.value)"></div>`;
              }
            } else if (typeof fv === 'number') {
              html += `<div class="item-field"><div class="item-field-label">${fLabel}</div><input class="set-input" type="number" value="${fv}" oninput="updateArrayItemField(${selectedIdx},'${key}',${itemIdx},'${fk}',Number(this.value))"></div>`;
            }
          }
        }
        html += `</div>`;
      });
      html += `</div>`;
      // Add item button
      html += `<button class="item-add-btn" onclick="addArrayItem(${selectedIdx},'${key}')">+ Add Item</button>`;
      html += `</div>`;
    }
  }
  html += '</div>';
  el.innerHTML = html;
}

function updateField(idx, key, val) {
  if (idx >= 0 && idx < sections.length) {
    sections[idx].data[key] = val;
    renderCanvas();
  }
}

function updateArrayField(idx, key, val) {
  try {
    sections[idx].data[key] = JSON.parse(val);
    renderCanvas();
  } catch(e) { /* ignore parse errors while typing */ }
}

function updateArrayItemField(idx, key, itemIdx, fieldKey, val) {
  if (idx >= 0 && idx < sections.length) {
    sections[idx].data[key][itemIdx][fieldKey] = val;
    renderCanvas();
  }
}

function removeArrayItem(idx, key, itemIdx) {
  if (idx >= 0 && idx < sections.length) {
    sections[idx].data[key].splice(itemIdx, 1);
    renderCanvas();
    renderSectionSettings();
  }
}

function addArrayItem(idx, key) {
  if (idx >= 0 && idx < sections.length) {
    const arr = sections[idx].data[key];
    if (arr.length === 0) return;
    // Clone the first item as a template, clear string values
    const template = JSON.parse(JSON.stringify(arr[0]));
    for (const k of Object.keys(template)) {
      if (typeof template[k] === 'string') template[k] = '';
    }
    arr.push(template);
    renderCanvas();
    renderSectionSettings();
    // Scroll to bottom of settings
    const el = document.getElementById('sectionSettings');
    setTimeout(() => el.scrollTop = el.scrollHeight, 50);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL STYLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setScheme(el) {
  document.querySelectorAll('.scheme-opt').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  scheme = el.dataset.scheme;
  renderCanvas();
}

function setAccent(el) {
  document.querySelectorAll('.accent-opt').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  accent = el.dataset.color;
  document.getElementById('customAccentPicker').value = accent;
  document.getElementById('customColorHex').style.display = 'none';
  renderCanvas();
}

function setCustomAccent(color) {
  document.querySelectorAll('.accent-opt').forEach(e => e.classList.remove('active'));
  accent = color;
  const hexEl = document.getElementById('customColorHex');
  hexEl.textContent = color.toUpperCase();
  hexEl.style.display = 'block';
  renderCanvas();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI GENERATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function aiGenerate() {
  const btn = document.getElementById('aiGenBtn');
  btn.disabled = true; btn.textContent = 'â³ Generating...';
  try {
    const res = await fetch('/api/funnels/generate-copy', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        template_type: 'opportunity',
        niche: document.getElementById('aiNiche').value,
        offer: document.getElementById('aiOffer').value,
      })
    });
    const data = await res.json();
    // Apply AI copy to matching sections
    sections.forEach(sec => {
      if (sec.data.headline !== undefined && data.headline) sec.data.headline = data.headline;
      if (sec.data.subheadline !== undefined && data.subheadline) sec.data.subheadline = data.subheadline;
      if (sec.data.bullets !== undefined && data.body_copy) sec.data.bullets = data.body_copy;
      if (sec.data.cta_text !== undefined && data.cta_text) sec.data.cta_text = data.cta_text;
    });
    renderCanvas();
    renderSectionSettings();
    showToast('AI copy applied to all sections!');
  } catch(e) { showToast('Error generating copy'); }
  btn.disabled = false; btn.textContent = 'ğŸ¤– Generate All Copy with AI';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE / PUBLISH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function savePage(status, openPreview) {
  const title = document.getElementById('pageTitleInput').value || 'My Page';
  try {
    const res = await fetch('/api/funnels/save', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        id: pageId, title, status,
        template_type: 'sections',
        body_copy: JSON.stringify(sections),
        color_scheme: scheme,
        accent_color: accent,
        headline: sections[0]?.data?.headline || title,
        subheadline: sections[0]?.data?.subheadline || '',
        cta_text: sections.find(s=>s.data.cta_text)?.data?.cta_text || '',
        cta_url: sections.find(s=>s.data.cta_url)?.data?.cta_url || '',
      })
    });
    const data = await res.json();
    if (data.success) {
      pageId = data.id;
      pageSlug = data.slug;
      if (!location.pathname.includes('/edit/')) history.replaceState(null,'','/funnels/edit/'+data.id);
      if (openPreview) {
        window.open('/p/'+data.slug, '_blank');
      } else if (status === 'published') {
        showUrlBanner(data.slug);
        showToast('Page published!');
      } else {
        showToast('Draft saved!');
      }
    } else showToast(data.error || 'Error saving');
  } catch(e) { showToast('Error saving'); }
}

function showUrlBanner(slug) {
  const fullUrl = window.location.origin + '/p/' + slug;
  let banner = document.getElementById('urlBanner');
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'urlBanner';
    document.body.appendChild(banner);
  }
  banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:10000;background:linear-gradient(135deg,#059669,#10b981);padding:14px 24px;display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;box-shadow:0 4px 20px rgba(0,0,0,0.3);animation:slideDown .3s ease';
  banner.innerHTML = '<span style="color:#fff;font-weight:700;font-size:16px">ğŸš€ Your page is LIVE!</span>'
    + '<div style="display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.2);border-radius:8px;padding:6px 12px">'
    + '<input id="urlCopyInput" readonly value="'+fullUrl+'" style="background:none;border:none;color:#fff;font-size:16px;font-family:monospace;width:'+Math.min(fullUrl.length*8.5,400)+'px;outline:none">'
    + '<button onclick="copyPageUrl()" style="background:#fff;color:#059669;border:none;border-radius:6px;padding:6px 14px;font-weight:700;font-size:16px;cursor:pointer;font-family:inherit;white-space:nowrap">ğŸ“‹ Copy URL</button>'
    + '</div>'
    + '<a href="/p/'+slug+'" target="_blank" style="color:#fff;font-size:16px;text-decoration:underline;white-space:nowrap">Open page â†’</a>'
    + '<button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(255,255,255,0.7);font-size:20px;cursor:pointer;margin-left:8px">Ã—</button>';
}

function copyPageUrl() {
  const input = document.getElementById('urlCopyInput');
  if (input) {
    navigator.clipboard.writeText(input.value).then(() => showToast('URL copied to clipboard!')).catch(() => {
      input.select(); document.execCommand('copy'); showToast('URL copied!');
    });
  }
}

function previewPage() {
  if (!pageSlug && !pageId) { showToast('Save your page first to preview'); return; }
  savePage('draft', true);
}

let pageSlug = '{{ page.slug if page else "" }}';

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  // Set initial scheme/accent from saved data
  document.querySelectorAll('.scheme-opt').forEach(e => e.classList.toggle('active', e.dataset.scheme === scheme));
  document.querySelectorAll('.accent-opt').forEach(e => e.classList.toggle('active', e.dataset.color === accent));
  document.getElementById('customAccentPicker').value = accent;
  initLibrary();
  renderCanvas();
});
</script>
</body>
</html>
